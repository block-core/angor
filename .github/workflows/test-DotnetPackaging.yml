name: Test dotnetpackager Tool

on:
  push:
    tags:
      - 'test-pkg-*'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_VERSION_TOOL: '10.0.101'
  AVALONIA_DIR: 'src/Angor/Avalonia'
  DESKTOP_PROJECT: 'src/Angor/Avalonia/AngorApp.Desktop/AngorApp.Desktop.csproj'
  APP_NAME: 'Angor'

jobs:
  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 9 (App)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Setup .NET 10 (Tool)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION_TOOL }}
      
      - name: Verify .NET versions
        run: |
          dotnet --list-sdks
          dotnet --version
      
      - name: Rename global.json
        run: Move-Item "global.json" "global.json.backup"
      
      - name: Install dotnetpackager Tool
        run: dotnet tool install -g DotnetPackaging.Tool
      
      - name: Verify tool installation
        run: dotnet tool list -g
      
      - name: Test Windows x64 build
        run: |
          dotnetpackager exe from-project `
            --project ${{ env.DESKTOP_PROJECT }} `
            --arch x64 `
            --output artifacts/Angor-test-win-x64-Setup.exe `
            --application-name "${{ env.APP_NAME }}" `
            --appId io.blockcore.angor `
            --version 0.0.1 `
            --vendor "Blockcore" `
            --self-contained
      
      - name: Restore global.json
        if: always()
        run: Move-Item "global.json.backup" "global.json" -ErrorAction SilentlyContinue
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-test
          path: artifacts/*

  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 9 (App)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Setup .NET 10 (Tool)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION_TOOL }}
      
      - name: Verify .NET versions
        run: |
          dotnet --list-sdks
          dotnet --version
      
      - name: Rename global.json
        run: mv global.json global.json.backup
      
      - name: Install dotnetpackager Tool
        run: dotnet tool install -g DotnetPackaging.Tool
      
      - name: Verify tool installation
        run: dotnetpackager --help
      
      - name: Test Linux x64 .deb build
        run: |
          dotnetpackager deb from-project \
            --project ${{ env.DESKTOP_PROJECT }} \
            --arch x64 \
            --output artifacts/angor_0.0.1_amd64.deb \
            --application-name "${{ env.APP_NAME }}" \
            --version 0.0.1 \
            --self-contained
      
      - name: Restore global.json
        if: always()
        run: mv global.json.backup global.json || true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-test
          path: artifacts/*

  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Rename global.json
        run: mv global.json global.json.backup
      
      - name: Setup .NET 9 (App)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Setup .NET 10 (Tool)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION_TOOL }}
      
      - name: Verify .NET versions
        run: |
          dotnet --list-sdks
          dotnet --version
      
      - name: Install dotnetpackager Tool
        run: dotnet tool install -g DotnetPackaging.Tool
      
      - name: Verify tool installation
        run: dotnetpackager --help
      
      - name: Test macOS x64 .dmg build
        run: |
          dotnetpackager dmg from-project \
            --project ${{ env.DESKTOP_PROJECT }} \
            --arch x64 \
            --output artifacts/Angor-test-osx-x64.dmg \
            --application-name "${{ env.APP_NAME }}" \
            --self-contained
      
      - name: Restore global.json
        if: always()
        run: mv global.json.backup global.json || true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-test
          path: artifacts/*

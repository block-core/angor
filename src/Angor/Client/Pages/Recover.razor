@page "/recover/{ProjectIdentifier}"

@using Angor.Shared
@using Angor.Client.Storage
@using Angor.Client.Services
@using Angor.Shared.Models
@using Angor.Shared.Services
@using Angor.Shared.Utilities
@using Blockcore.Consensus.TransactionInfo
@using Blockcore.NBitcoin
@using Blockcore.NBitcoin.DataEncoders
@using Angor.Client.Models
@using Angor.Shared.Protocol

@inject INetworkService _NetworkService
@inject IClientStorage storage;
@inject ICacheStorage _cacheStorage;
@inject IIndexerService _IndexerService
@inject INetworkConfiguration _NetworkConfiguration
@inject IDerivationOperations _derivationOperations
@inject IWalletOperations _WalletOperations
@inject IInvestorTransactionActions _InvestorTransactionActions
@inject ILogger<Recover> Logger;
@inject IWalletUIService _walletUIService;
@inject ISignService SignService
@inject ICurrencyService _currencyService
@inject NavMenuState NavMenuState
@inject IJSRuntime JS
@inject NostrConversionHelper NostrHelper
@inject IRelayService _RelayService

@inherits BaseComponent

<NotificationComponent @ref="notificationComponent" />
<PasswordComponent @ref="passwordComponent" />

@if (!hasWallet)
{
    NavigationManager.NavigateTo($"/wallet");
    return;
}
<div class="header-container slide-in">
    <div class="card card-body">
        <div class="header-content">
            <div class="header-title animate-fade-in">
                <span class="header-icon-wrapper">
                    <Icon IconName="recovery" Width="32" Height="32" />
                </span>
                <h5 class="header-text">Manage Investment (@project.Metadata?.Name)</h5>
            </div>
<div class="header-actions">
    <button class="btn btn-border-success btn-refresh-fixed"
            @onclick="RefreshInvestments"
            disabled="@refreshSpinner"
            title="Refresh">
        @if (refreshSpinner)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        }
        else
        {
            <Icon IconName="refresh" Height="24" Width="24" />
            <span class="button-text ms-2">Refresh</span>
        }
    </button>
    <button class="btn btn-border-success ms-2" @onclick="ShowMessageWithPassword" title="Message">
        <Icon IconName="chat" Width="24" Height="24" />
        @if (hasMessges)
        {
            <span class="button-text ms-2">Pending Message</span>
        }
        else
        {
            <span class="button-text ms-2">Message</span>
        }
    </button>
</div>
        </div>
    </div>
</div>

<div class="row slide-in mt-4">
    <div class="card card-body">
        <p class="mb-0 font-weight-normal text-sm animate-fade-in-delayed">
            Project ID: @ProjectIdentifier
        </p>
    </div>
</div>

<div class="slide-in mt-4">
    @if (firstTimeRefreshSpinner && refreshSpinner)
    {
        <div class="row card card-body">
            <div class="d-flex justify-content-center">
                <div class="loader"></div>
            </div>
        </div>
    }
    else
    {
        <div class="card card-body slide-up">

            <div class="row g-4">
                <div class="col-md-6 h-100">
                    <div class="stat-card p-3 rounded-3 border hover-effect h-100">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Total Funds</h6>
                                <h4 class="mb-0">@Money.Satoshis(StageInfo.TotalSpendable).ToUnit(MoneyUnit.BTC) @network.CoinTicker</h4>
                            </div>
                            <div class="stat-icon">
                                <Icon IconName="wallet" Height="32" Width="32" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 h-100">
                    <div class="stat-card p-3 rounded-3 border hover-effect h-100">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Expiry Date</h6>
                                <h4 class="mb-0">@project.ProjectInfo.ExpiryDate.FormatDate()</h4>
                            </div>
                            <div class="stat-icon">
                                <Icon IconName="calendar" Height="32" Width="32" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="stat-card p-3 rounded-3 border hover-effect h-100">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Penalty Period</h6>
                                <h4 class="mb-0">@project.ProjectInfo.PenaltyDays days</h4>
                            </div>
                            <div class="stat-icon">
                                <Icon IconName="unlock" Height="32" Width="32" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="stat-card p-3 rounded-3 border hover-effect h-100">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">Transaction</h6>
                                <div class="d-flex align-items-center">

                                    @if (!string.IsNullOrEmpty(explorerLink))
                                    {
                                        <a href="@explorerLink" rel="noopener noreferrer" target="_blank" class="btn btn-sm btn-border">
                                            <Icon IconName="external-link" Height="16" Width="16" />
                                            <span class="ms-1">View</span>
                                        </a>
                                    }
                                </div>
                            </div>
                            <div class="stat-icon">
                                <Icon IconName="explorer" Height="32" Width="32" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (StageInfo.CanRelease)
            {
                <div class="row g-4 mt-4">
                    <div class="col-md-6 col-lg-4">
                        <div class="stat-card p-3 rounded-3 border hover-effect">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-muted">In Penalty</h6>
                                    <h4 class="mb-0">@Money.Satoshis(StageInfo.TotalInPenalty).ToUnit(MoneyUnit.BTC) @network.CoinTicker</h4>
                                </div>
                                <div class="stat-icon">
                                    <Icon IconName="penalty" Height="32" Width="32" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (releaseSigsfound)
            {
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-border-warning me-2 btn-border-warning" @onclick="NavigatetoReleaseSigs">Target not met go to Release Funds</button>
                </div>
            }
            else
            {
                <div class="d-flex justify-content-between mt-4">

                    @if (!refreshSpinner)
                    {
                        @if (StageInfo.CanRelease)
                        {
                            <p class="mb-3">Total funds in penalty = @(Money.Satoshis(StageInfo.TotalInPenalty).ToUnit(MoneyUnit.BTC)) @network.CoinTicker</p>
                        }

                        @if (StageInfo.CanRecover && !StageInfo.EndOfProject)
                        {
                            <button class="btn btn-border-warning me-2" @onclick="PrepareToRecoverCoinsCheckPassword" disabled="@PrepareToRecoverCoinsModalSpinner">
                                @if (PrepareToRecoverCoinsModalSpinner)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Recover Funds...</span>
                                }
                                else
                                {
                                    <span>Recover Funds</span>
                                }
                            </button>
                        }

                        @if (StageInfo.CanRelease)
                        {
                            <button class="btn btn-border-success me-2" @onclick="PrepareToReleaseCoinsCheckPassword" disabled="@PrepareToReleaseCoinsModalSpinner">
                                @if (PrepareToReleaseCoinsModalSpinner)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Release Funds...</span>
                                }
                                else
                                {
                                    <span>Release Funds</span>
                                }
                            </button>
                        }

                        @if (StageInfo.EndOfProject && StageInfo.TotalSpendable > 0)
                        {
                            <button class="btn btn-border-warning btn-sm" @onclick="PrepareEndOfProjectCoinsCheckPassword" disabled="@PrepareEndOfProjectCoinsModalSpinner">
                                @if (PrepareEndOfProjectCoinsModalSpinner)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>End of project...</span>
                                }
                                else
                                {
                                    <span>End of project</span>
                                }
                            </button>
                        }
                    }

                </div>
            }

            @if (StageInfo.Items.Count() > 0)
            {
                <div class="table-responsive form-control mt-4">
                    <table class="table align-items-center mb-0">
                        <thead>
                            <tr>
                                <th>Stage </th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in StageInfo.Items)
                            {
                                <tr>
                                    <td>@(item.StageIndex + 1)</td>
                                    <td>@(_currencyService.ToBtc(item.Amount)) @network.CoinTicker</td>
                                    <td>
                                        @if (item.IsSpent)
                                        {
                                            <span class="text-primary">@item.SpentTo</span>
                                        }
                                        else
                                        {
                                            <span class="text-success">Not Spent</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        @if (showRecoveryModal)
        {
            <div class="modal-wrapper">
                <div class="modal fade show d-block" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content modern-modal">
                            <div class="modal-header border-0 pb-0">
                                <div class="d-flex align-items-center">
                                    <Icon IconName="recovery" Height="32" Width="32" class="me-2" />
                                    <h5 class="modal-title">Recovery Confirmation</h5>
                                </div>
                                <button class="btn-close-custom" @onclick="() => showRecoveryModal = false" disabled="@PrepareToRecoverCoinsConfirmSpinner">
                                    <Icon IconName="close-circle" Height="24" Width="24" />
                                </button>
                            </div>

                            <div class="modal-body modal-body-scroll py-4">
                                <div class="info-card mb-3">
                                    <p class="text-muted mb-0">
                                        When you recover funds, they will be locked in a penalty period. After this period ends, you can release these funds back to your wallet.
                                    </p>
                                </div>

                                <div class="row g-4 mb-4">
                                    <div class="col-md-6">
                                        <div class="info-card h-100">
                                            <div class="info-label">Stages to Recover</div>
                                            <div class="info-value">@StageInfo.Items.Count(s => !s.IsSpent)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-card h-100">
                                            <div class="info-label">Amount to Recover</div>
                                            <div class="info-value text-success">
                                                @{
                                                    var totalAmount = StageInfo.Items
                                                    .Where(s => !s.IsSpent)
                                                    .Sum(s => Money.Satoshis(s.Amount).ToUnit(MoneyUnit.BTC));
                                                }
                                                @totalAmount @network.CoinTicker
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-card h-100">
                                            <div class="info-label">Penalty Duration</div>
                                            <div class="info-value text-warning">@project.ProjectInfo.PenaltyDays days</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-card h-100">
                                            <div class="info-label">Miner Fee</div>
                                            <div class="info-value text-warning">@Money.Satoshis(recoveryTransaction?.TransactionFee ?? 0).ToUnit(MoneyUnit.BTC) @network.CoinTicker</div>
                                        </div>
                                    </div>
                                </div>

                                <FeeSelector SendFee="@Money.Satoshis(recoveryTransaction?.TransactionFee ?? 0).ToUnit(MoneyUnit.BTC)"
                                             CoinTicker="@network.CoinTicker"
                                             FeeRate="@feeData.SelectedFeeEstimation.FeeRate"
                                             FeeBlockCount="@feeData.SelectedFeeEstimation.Confirmations"
                                             FeePosition="@feeData.FeePosition"
                                             FeeMin="@feeData.FeeMin"
                                             FeeMax="@feeData.FeeMax"
                                             OnFeeChanged="@HandleRecoveryFeeChanged" />

                                <div class="confirmation-section mt-4 text-center">
                                    <Icon IconName="alert" Height="24" Width="24" class="mb-2" />
                                    <p class="confirmation-text">
                                        Are you sure you want to recover these funds?
                                    </p>
                                </div>
                            </div>

                            <div class="modal-footer border-0 pt-0">
                                <button class="btn btn-border-warning btn-sm" @onclick="() => showRecoveryModal = false" disabled="@PrepareToRecoverCoinsConfirmSpinner">Cancel</button>
                                <button class="btn btn-border-success btn-sm" @onclick="RecoverCoins" disabled="@PrepareToRecoverCoinsConfirmSpinner">
                                    @if (PrepareToRecoverCoinsConfirmSpinner)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Confirming...</span>
                                    }
                                    else
                                    {
                                        <span>Confirm</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (showRecoveryReleaseModal)
        {
            <div class="modal-wrapper">
                <div class="modal fade show d-block" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content modern-modal">
                            <div class="modal-header border-0 pb-0">
                                <div class="info-card mb-3">
                                    <p class="text-muted mb-0">
                                        The penalty period has ended. You can now release your recovered funds back to your wallet.
                                    </p>
                                </div>
                                <div class="d-flex align-items-center">
                                    <Icon IconName="release" Height="32" Width="32" class="me-2" />
                                    <h5 class="modal-title">Release Recovery Confirmation</h5>
                                </div>
                                <button class="btn-close-custom" @onclick="() => showRecoveryReleaseModal = false" disabled="@PrepareToReleaseCoinsConfirmSpinner">
                                    <Icon IconName="close-circle" Height="24" Width="24" />
                                </button>
                            </div>

                            <div class="modal-body modal-body-scroll py-4">
                                <div class="row g-4 mb-4">
                                    <div class="col-md-12">
                                        <div class="info-card h-100">
                                            <div class="info-label">Amount to Release</div>
                                            <div class="info-value text-success">@Money.Satoshis(releaseRecoveryTransaction.Transaction.Outputs.Sum(s => s.Value)).ToUnit(MoneyUnit.BTC) @network.CoinTicker</div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="info-card h-100">
                                            <div class="info-label">Destination Address</div>
                                            <div class="info-value">@releaseRecoveryTransaction.Transaction.Outputs[0].ScriptPubKey.GetDestinationAddress(_NetworkConfiguration.GetNetwork())</div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="info-card h-100">
                                            <div class="info-label">Miner Fee</div>
                                            <div class="info-value text-warning">@Money.Satoshis(releaseRecoveryTransaction?.TransactionFee ?? 0).ToUnit(MoneyUnit.BTC) @network.CoinTicker</div>
                                        </div>
                                    </div>
                                </div>
                                <FeeSelector SendFee="@Money.Satoshis(releaseRecoveryTransaction?.TransactionFee ?? 0).ToUnit(MoneyUnit.BTC)"
                                             CoinTicker="@network.CoinTicker"
                                             FeeRate="@feeData.SelectedFeeEstimation.FeeRate"
                                             FeeBlockCount="@feeData.SelectedFeeEstimation.Confirmations"
                                             FeePosition="@feeData.FeePosition"
                                             FeeMin="@feeData.FeeMin"
                                             FeeMax="@feeData.FeeMax"
                                             OnFeeChanged="@HandleReleaseFeeChanged" />

                                <div class="confirmation-section mt-4 text-center">
                                    <Icon IconName="alert" Height="24" Width="24" class="mb-2" />
                                    <p class="confirmation-text">
                                        Are you sure you want to release these funds from the penalty?
                                    </p>
                                </div>
                            </div>

                            <div class="modal-footer border-0 pt-0">
                                <button class="btn btn-border-warning btn-sm" @onclick="() => showRecoveryReleaseModal = false" disabled="@PrepareToReleaseCoinsConfirmSpinner">Cancel</button>
                                <button class="btn btn-border-success btn-sm" @onclick="ReleaseCoins" disabled="@PrepareToReleaseCoinsConfirmSpinner">
                                    @if (PrepareToReleaseCoinsConfirmSpinner)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Confirming...</span>
                                    }
                                    else
                                    {
                                        <span>Confirm</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (showEndOfProjectModal)
        {
            <div class="modal-wrapper">
                <div class="modal fade show d-block" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content modern-modal">
                            <div class="modal-header border-0 pb-0">
                                <div class="info-card mb-3">
                                    <p class="text-muted mb-0">
                                        The project has ended. You can now claim any remaining funds without any penalty.
                                    </p>
                                </div>
                                <div class="d-flex align-items-center">
                                    <Icon IconName="end" Height="32" Width="32" class="me-2" />
                                    <h5 class="modal-title">End Of Project Confirmation</h5>
                                </div>
                                <button class="btn-close-custom" @onclick="() => showEndOfProjectModal = false" disabled="@PrepareEndOfProjectCoinsConfirmSpinner">
                                    <Icon IconName="close-circle" Height="24" Width="24" />
                                </button>
                            </div>

                            <div class="modal-body modal-body-scroll py-4">
                                <div class="row g-4">
                                    <div class="col-md-12">
                                        <div class="info-card h-100">
                                            <div class="info-label">Amount to Claim</div>
                                            <div class="info-value text-success">@Money.Satoshis(endOfProjectTransaction.Transaction.Outputs.Sum(s => s.Value)).ToUnit(MoneyUnit.BTC) @network.CoinTicker</div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="info-card h-100">
                                            <div class="info-label">Destination Address</div>
                                            <div class="info-value">@endOfProjectTransaction.Transaction.Outputs[0].ScriptPubKey.GetDestinationAddress(_NetworkConfiguration.GetNetwork())</div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="info-card h-100">
                                            <div class="info-label">Miner Fee</div>
                                            <div class="info-value text-warning">@Money.Satoshis(endOfProjectTransaction?.TransactionFee ?? 0).ToUnit(MoneyUnit.BTC) @network.CoinTicker</div>
                                        </div>
                                    </div>
                                </div>

                                <FeeSelector SendFee="@Money.Satoshis(endOfProjectTransaction?.TransactionFee ?? 0).ToUnit(MoneyUnit.BTC)"
                                             CoinTicker="@network.CoinTicker"
                                             FeeRate="@feeData.SelectedFeeEstimation.FeeRate"
                                             FeeBlockCount="@feeData.SelectedFeeEstimation.Confirmations"
                                             FeePosition="@feeData.FeePosition"
                                             FeeMin="@feeData.FeeMin"
                                             FeeMax="@feeData.FeeMax"
                                             OnFeeChanged="@HandleEndOfProjectFeeChanged" />

                                <div class="confirmation-section mt-4 text-center">
                                    <Icon IconName="alert" Height="24" Width="24" class="mb-2" />
                                    <p class="confirmation-text">
                                        Are you sure you want to claim these funds?
                                    </p>
                                </div>
                            </div>

                            <div class="modal-footer border-0 pt-0">
                                <button class="btn btn-border-warning btn-sm" @onclick="() => showEndOfProjectModal = false" disabled="@PrepareEndOfProjectCoinsConfirmSpinner">Cancel</button>
                                <button class="btn btn-border-success btn-sm" @onclick="EndOfProjectCoins" disabled="@PrepareEndOfProjectCoinsConfirmSpinner">
                                    @if (PrepareEndOfProjectCoinsConfirmSpinner)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Confirming...</span>
                                    }
                                    else
                                    {
                                        <span>Confirm</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (showMessageModal)
        {
            <MessageComponent 
                OtherUserPubkeyHex="@project.ProjectInfo.NostrPubKey"
                CurrentUserPrvKeyHex="@currentUserPrivateKeyHex"
                MessageTitle="Founder"
                OnClose="@OnMessageModalClose"
                OnNsecRequest="@ShowNsecAndCheckPassword"
                OnNotification="@((message) => notificationComponent.ShowNotificationMessage(message, 2))" />
        }
    }
</div>

@code {
    [Parameter] public string ProjectIdentifier { get; set; }
    private InvestorProject project;

    private bool showRecoveryModal = false;
    private bool showRecoveryReleaseModal = false;
    private bool showEndOfProjectModal = false;
    private bool showMessageModal = false;
    private bool showNsec = false;
    private string nsecValue = "";
    private string npubValue = "";
    private string founderNpub = "";
    private string currentUserPrivateKeyHex = "";

    private bool refreshSpinner = false;
    private bool firstTimeRefreshSpinner = false;
    private bool PrepareToRecoverCoinsModalSpinner = false;
    private bool PrepareToRecoverCoinsConfirmSpinner = false;

    private bool PrepareToReleaseCoinsModalSpinner = false;
    private bool PrepareToReleaseCoinsConfirmSpinner = false;

    private bool PrepareEndOfProjectCoinsModalSpinner = false;
    private bool PrepareEndOfProjectCoinsConfirmSpinner = false;

    private Transaction? investmentTransaction;
    private Transaction? unsignedRecoveryTransaction;
    private TransactionInfo? recoveryTransaction;
    private TransactionInfo? releaseRecoveryTransaction;
    private TransactionInfo? endOfProjectTransaction;

    private bool releaseSigsfound = false;

    StageData StageInfo = new();
    string explorerLink;

    private FeeData feeData = new();

    private bool trxNotFound = false;

    public class StageData
    {
        public QueryTransaction? TransactionInfo;
        public long TotalSpendable;
        public long TotalInPenalty;
        public bool CanRecover;
        public bool CanRelease;
        public bool EndOfProject;

        public List<StageDataTrx> Items = new();
    }

    public class StageDataTrx
    {
        public int StageIndex;

        public int Outputindex;
        public string OutputAddress;
        public long Amount; // Store amount in satoshis
        public bool IsSpent;
        public string SpentTo;

        public ProjectScriptType ProjectScriptType;
    }

    protected override async Task OnInitializedAsync()
    {
        NavMenuState.SetActivePage("investor");

        project = storage.GetInvestmentProjects().First(p => p.ProjectInfo.ProjectIdentifier == ProjectIdentifier);

        firstTimeRefreshSpinner = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (hasWallet)
            {
                await RefreshInvestments();
            }
        }
    }

    private async Task RefreshInvestments()
    {
        refreshSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            CheckReleaseSignatures();

            await FindInvestments();

            await CheckSpentFund();

            ScanForDmMessages();
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            refreshSpinner = false;
            firstTimeRefreshSpinner = false;
        }

        StateHasChanged();
        await Task.Delay(10);
    }

    protected void CheckReleaseSignatures()
    {
        SignService.LookupReleaseSigs(
            project.InvestorNPub,
            project.ProjectInfo.NostrPubKey,
            null,
            project.SignaturesInfo?.SignatureRequestEventId!,
            _ =>
            {
                releaseSigsfound = true;
                StateHasChanged();
            }, () => { });
    }

    private async Task FindInvestments()
    {
        if (StageInfo.TransactionInfo != null)
        {
            // we already fetched the trx info
            return;
        }

        var trxs = await _IndexerService.GetInvestmentsAsync(project.ProjectInfo.ProjectIdentifier);

        var trx = trxs.FirstOrDefault(f => f.TransactionId == project.TransactionId);

        if (trx == null)
        {
            explorerLink = _NetworkService.GetPrimaryExplorer().Url + $"/tx/{project.TransactionId}";
            trxNotFound = true;
            return;
        }

        trxNotFound = false;

        if (investmentTransaction == null)
        {
            var trxHex = await _IndexerService.GetTransactionHexByIdAsync(project.TransactionId);
            investmentTransaction = network.CreateTransaction(trxHex);
        }

        var trxInfo = await _IndexerService.GetTransactionInfoByIdAsync(trx.TransactionId);

        StageInfo.TransactionInfo = trxInfo;
        lastCheck = DateTime.UtcNow;

        explorerLink = _NetworkService.GetPrimaryExplorer().Url + $"/tx/{trx.TransactionId}";

        StageInfo.Items.Clear();

        int stageIndex = 0;
        foreach (var stageInfo in project.ProjectInfo.Stages)
        {
            var output = trxInfo.Outputs.First(f => f.Index == stageIndex + 2);

            var insert = new StageDataTrx
                {
                    OutputAddress = output.Address,
                    Outputindex = stageIndex + 2,
                    Amount = output.Balance, // Store balance in satoshis
                    StageIndex = stageIndex,
                    IsSpent = false,
                };

            StageInfo.Items.Add(insert);

            stageIndex++;
        }
    }

    DateTime lastCheck = DateTime.UtcNow;

    private async Task CheckSpentFund()
    {
        if (StageInfo.TransactionInfo == null)
        {
            return;
        }

        if ((DateTime.UtcNow - lastCheck).Minutes > 1)
        {
            var trxInfo = await _IndexerService.GetTransactionInfoByIdAsync(StageInfo.TransactionInfo.TransactionId);
            StageInfo.TransactionInfo = trxInfo;
            lastCheck = DateTime.UtcNow;
        }
        else
        {
            await Task.Delay(500); // fake
        }

        var unconfirmedOutbound = _cacheStorage.GetUnconfirmedOutboundFunds();
        bool modified = false;

        foreach (var infoOutput in StageInfo.TransactionInfo.Outputs)
        {
            if (!string.IsNullOrEmpty(infoOutput.SpentInTransaction))
            {
                modified |= unconfirmedOutbound.TryRemoveOutpoint(new Outpoint(StageInfo.TransactionInfo.TransactionId, infoOutput.Index));
            }
        }

        if (modified)
        {
            _cacheStorage.SetUnconfirmedOutboundFunds(unconfirmedOutbound);
        }

        var penaltyExpieryDate = Utils.UnixTimeToDateTime(StageInfo.TransactionInfo.Timestamp).AddDays(project.ProjectInfo.PenaltyDays);

        if (!string.IsNullOrEmpty(project.RecoveryTransactionId))
        {
            var recoveryTansaction = await _IndexerService.GetTransactionInfoByIdAsync(project.RecoveryTransactionId);
            if (recoveryTansaction != null) 
                penaltyExpieryDate = Utils.UnixTimeToDateTime(recoveryTansaction.Timestamp).AddDays(project.ProjectInfo.PenaltyDays);
        }

        foreach (var item in StageInfo.Items)
        {
            if (unconfirmedOutbound.ContainsOutpoint(new Outpoint(StageInfo.TransactionInfo.TransactionId, item.Outputindex)))
            {
                item.IsSpent = true;
                item.SpentTo = "pending confirmations";
                item.ProjectScriptType = new ProjectScriptType { ScriptType = ProjectScriptTypeEnum.Unknown };

                continue;
            }

            var output = StageInfo.TransactionInfo.Outputs.ElementAt(item.Outputindex);

            if (!string.IsNullOrEmpty(output.SpentInTransaction))
            {
                item.IsSpent = true;

                if (output.SpentInTransaction == project.UnfundedReleaseTransactionId)
                {
                    item.SpentTo = "Project Unfunded, Spent back to investor";
                    item.ProjectScriptType = new ProjectScriptType { ScriptType = ProjectScriptTypeEnum.InvestorNoPenalty };
                }
                else
                {
                    if (output.SpentInTransaction == project.RecoveryTransactionId)
                    {
                        if (!string.IsNullOrEmpty(project.RecoveryReleaseTransactionId))
                        {
                            item.SpentTo = "Recovered after penalty";
                            item.ProjectScriptType = new ProjectScriptType { ScriptType = ProjectScriptTypeEnum.Unknown };
                        }
                        else
                        {
                            item.ProjectScriptType = new ProjectScriptType { ScriptType = ProjectScriptTypeEnum.InvestorWithPenalty };
                            var days = (penaltyExpieryDate - DateTime.Now).TotalDays;
                            item.SpentTo = days > 0 ? $"Penalty, released in {days.ToString("0.0")} days" : "Penalty can be released";
                        }
                    }
                    else
                    {
                        // try to resolve the destination
                        var spentInTransaction = await _IndexerService.GetTransactionInfoByIdAsync(output.SpentInTransaction);

                        var input = spentInTransaction?.Inputs.FirstOrDefault(input => input.InputTransactionId == StageInfo.TransactionInfo.TransactionId && input.InputIndex == item.Outputindex);

                        if (input != null && investmentTransaction != null)
                        {
                            item.ProjectScriptType = _InvestorTransactionActions.DiscoverUsedScript(project.ProjectInfo, investmentTransaction, item.StageIndex, input.WitScript);

                            switch (item.ProjectScriptType.ScriptType)
                            {
                                case ProjectScriptTypeEnum.Founder:
                                    {
                                        item.SpentTo = "Spent by founder";
                                        break;
                                    }
                                case ProjectScriptTypeEnum.InvestorWithPenalty:
                                    {
                                        var days = (penaltyExpieryDate - DateTime.Now).TotalDays;
                                        item.SpentTo = days > 0 ? $"Penalty, released in {days.ToString("0.0")} days" : "Penalty can be released";
                                        break;
                                    }
                                case ProjectScriptTypeEnum.EndOfProject:
                                case ProjectScriptTypeEnum.InvestorNoPenalty:
                                    {
                                        item.SpentTo = $"Spent by investor";
                                        break;
                                    }
                            }
                        }
                    }
                }
            }
        }

        StageInfo.CanRecover = StageInfo.Items.Any(a => a.IsSpent == false);
        StageInfo.TotalSpendable = StageInfo.Items.Where(a => !a.IsSpent).Sum(a => a.Amount);
        StageInfo.CanRelease = (StageInfo.Items.Any(a => a.ProjectScriptType?.ScriptType == ProjectScriptTypeEnum.InvestorWithPenalty) && DateTime.UtcNow > penaltyExpieryDate);
        StageInfo.TotalInPenalty = StageInfo.Items.Where(t => t.ProjectScriptType?.ScriptType == ProjectScriptTypeEnum.InvestorWithPenalty).Sum(t => t.Amount);
        StageInfo.EndOfProject = project.ProjectInfo.ExpiryDate < DateTime.Now;
    }

    private async Task PrepareToRecoverCoinsCheckPassword()
    {
        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(PrepareToRecoverCoins);
        }
        else
        {
            await PrepareToRecoverCoins();
        }
    }

    private async Task PrepareToRecoverCoins()
    {
        PrepareToRecoverCoinsModalSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            var fetchFees = await _WalletOperations.GetFeeEstimationAsync();
            feeData.FeeEstimations.Fees.Clear();
            feeData.FeeEstimations.Fees.AddRange(fetchFees);
            feeData.SelectedFeeEstimation = feeData.FeeEstimations.Fees.First();

            var accountBalanceInfo = await _walletUIService.RefreshWalletBalance();
            var accountInfo = accountBalanceInfo.AccountInfo;
            var words = await passwordComponent.GetWalletAsync();

            var investorPrivateKey = _derivationOperations.DeriveInvestorPrivateKey(words, project.ProjectInfo.FounderKey);

            unsignedRecoveryTransaction = _InvestorTransactionActions.AddSignaturesToRecoverSeederFundsTransaction(project.ProjectInfo, investmentTransaction, project.SignaturesInfo, Encoders.Hex.EncodeData(investorPrivateKey.ToBytes()));

            // remove outputs that have been spent
            List<TxOut> removeTxout = new();
            List<TxIn> removeTxin = new();
            foreach (var item in StageInfo.Items)
            {
                if (item.IsSpent)
                {
                    removeTxout.Add(unsignedRecoveryTransaction.Outputs[item.StageIndex]);
                    removeTxin.Add(unsignedRecoveryTransaction.Inputs[item.StageIndex]);
                }
            }

            foreach (var txOut in removeTxout) unsignedRecoveryTransaction.Outputs.Remove(txOut);
            foreach (var txIn in removeTxin) unsignedRecoveryTransaction.Inputs.Remove(txIn);

            // add fee to the recovery trx
            recoveryTransaction = _WalletOperations.AddFeeAndSignTransaction(accountInfo.GetNextChangeReceiveAddress(), unsignedRecoveryTransaction, words, accountInfo, feeData.SelectedFeeEstimation.FeeRate);
            // todo: instead call the method psbt.CreatePsbtForTransactionFee 

            Logger.LogInformation($"recoveryTransaction={recoveryTransaction.Transaction.GetHash().ToString()}");

            showRecoveryModal = true;
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            PrepareToRecoverCoinsModalSpinner = false;
        }

        StateHasChanged();
    }

    private async Task HandleRecoveryFeeChanged(FeeCalculation feeCalc)
    {
        if (!passwordComponent.HasPassword())
        {
            showRecoveryModal = false;
            notificationComponent.ShowErrorMessage("Wallet password expired");
            return;
        }

        try
        {
            if (feeCalc.UseCustomFee && feeCalc.CustomFee.HasValue)
            {
                feeData.SetCustomFee(feeCalc.CustomFee.Value);
            }
            else if (feeCalc.Position.HasValue && feeCalc.Position.Value <= feeData.FeeEstimations.Fees.Count)
            {
                feeData.SelectFee(feeCalc.Position.Value);
            }

            var words = await passwordComponent.GetWalletAsync();
            var accountInfo = storage.GetAccountInfo(network.Name);

            // todo: instead call the method psbt.CreatePsbtForTransactionFee
            recoveryTransaction = _WalletOperations.AddFeeAndSignTransaction(
                accountInfo.GetNextChangeReceiveAddress(),
                unsignedRecoveryTransaction,
                words,
                accountInfo,
                feeData.SelectedFeeEstimation.FeeRate);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating fee");
            notificationComponent.ShowErrorMessage("Error calculating fee: " + ex.Message);
        }
    }

    private async Task RecoverCoins()
    {
        PrepareToRecoverCoinsConfirmSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            showRecoveryModal = false;

            storage.UpdateInvestmentProject(project);

            Logger.LogInformation($"recover trx hex = {recoveryTransaction.Transaction.ToHex(network.Consensus.ConsensusFactory)}");

            var response = await _WalletOperations.PublishTransactionAsync(network, recoveryTransaction.Transaction);

            if (!response.Success)
            {
                notificationComponent.ShowErrorMessage("Transaction failed", response.Message);
                return;
            }

            // the last output is the change so no penalty on that output
            var totalsats = recoveryTransaction.Transaction.Outputs.SkipLast(1).Sum(s => s.Value.Satoshi);

            project.RecoveryTransactionId = recoveryTransaction.Transaction.GetHash().ToString();
            project.AmountInRecovery = totalsats;


            storage.UpdateInvestmentProject(project);

            _walletUIService.AddTransactionToPending(recoveryTransaction.Transaction);

            await RefreshInvestments();

            notificationComponent.ShowNotificationMessage("Transaction submitted successfully", 5);

        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            PrepareToRecoverCoinsConfirmSpinner = false;
            passwordComponent.ClearPassword();
        }
    }

    private async Task PrepareToReleaseCoinsCheckPassword()
    {
        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(PrepareToReleaseCoins);
        }
        else
        {
            await PrepareToReleaseCoins();
        }
    }

    private async Task PrepareToReleaseCoins()
    {
        PrepareToReleaseCoinsModalSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            var fetchFees = await _WalletOperations.GetFeeEstimationAsync();
            feeData.FeeEstimations.Fees.Clear();
            feeData.FeeEstimations.Fees.AddRange(fetchFees);
            feeData.SelectedFeeEstimation = feeData.FeeEstimations.Fees.First();

            var accountBalanceInfo = await _walletUIService.RefreshWalletBalance();
            var accountInfo = accountBalanceInfo.AccountInfo;
            var words = await passwordComponent.GetWalletAsync();

            var investorPrivateKey = _derivationOperations.DeriveInvestorPrivateKey(words, project.ProjectInfo.FounderKey);

            if (recoveryTransaction == null)
            {
                recoveryTransaction = new TransactionInfo();

                var trxHex = await _IndexerService.GetTransactionHexByIdAsync(project.RecoveryTransactionId);
                recoveryTransaction.Transaction = network.CreateTransaction(trxHex);
            }

            releaseRecoveryTransaction = _InvestorTransactionActions.BuildAndSignRecoverReleaseFundsTransaction(project.ProjectInfo, investmentTransaction, recoveryTransaction.Transaction,
                accountInfo.GetNextChangeReceiveAddress(), feeData.SelectedFeeEstimation, Encoders.Hex.EncodeData(investorPrivateKey.ToBytes()));

            Logger.LogInformation($"recoveryReleaseTransactionId={releaseRecoveryTransaction.Transaction.GetHash().ToString()}");

            showRecoveryReleaseModal = true;
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            PrepareToReleaseCoinsModalSpinner = false;
        }

        StateHasChanged();
    }

    private async Task HandleReleaseFeeChanged(FeeCalculation feeCalc)
    {
        if (!passwordComponent.HasPassword())
        {
            showRecoveryReleaseModal = false;
            notificationComponent.ShowErrorMessage("Wallet password expired");
            return;
        }

        try
        {
            if (feeCalc.UseCustomFee && feeCalc.CustomFee.HasValue)
            {
                feeData.SetCustomFee(feeCalc.CustomFee.Value);
            }
            else if (feeCalc.Position.HasValue && feeCalc.Position.Value <= feeData.FeeEstimations.Fees.Count)
            {
                feeData.SelectFee(feeCalc.Position.Value);
            }

            var words = await passwordComponent.GetWalletAsync();
            var accountInfo = storage.GetAccountInfo(network.Name);
            var investorPrivateKey = _derivationOperations.DeriveInvestorPrivateKey(words, project.ProjectInfo.FounderKey);

            releaseRecoveryTransaction = _InvestorTransactionActions.BuildAndSignRecoverReleaseFundsTransaction(
                project.ProjectInfo,
                investmentTransaction,
                recoveryTransaction.Transaction,
                accountInfo.GetNextChangeReceiveAddress(),
                feeData.SelectedFeeEstimation,
                Encoders.Hex.EncodeData(investorPrivateKey.ToBytes()));

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating fee");
            notificationComponent.ShowErrorMessage("Error calculating fee: " + ex.Message);
        }
    }

    private async Task ReleaseCoins()
    {
        PrepareToReleaseCoinsConfirmSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            showRecoveryReleaseModal = false;

            storage.UpdateInvestmentProject(project);

            Logger.LogInformation($"release trx hex = {releaseRecoveryTransaction.Transaction.ToHex(network.Consensus.ConsensusFactory)}");

            var response = await _WalletOperations.PublishTransactionAsync(network, releaseRecoveryTransaction.Transaction);

            if (!response.Success)
            {
                notificationComponent.ShowErrorMessage("Transaction failed", response.Message);
                return;
            }

            project.RecoveryReleaseTransactionId = releaseRecoveryTransaction.Transaction.GetHash().ToString();

            storage.UpdateInvestmentProject(project);

            _walletUIService.AddTransactionToPending(releaseRecoveryTransaction.Transaction);

            await RefreshInvestments();

            notificationComponent.ShowNotificationMessage("Transaction submitted successfully", 5);

        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            PrepareToReleaseCoinsConfirmSpinner = false;
            passwordComponent.ClearPassword();
        }
    }

    private async Task PrepareEndOfProjectCoinsCheckPassword()
    {
        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(PrepareEndOfProjectCoins);
        }
        else
        {
            await PrepareEndOfProjectCoins();
        }
    }

    private async Task PrepareEndOfProjectCoins()
    {
        PrepareEndOfProjectCoinsModalSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            var fetchFees = await _WalletOperations.GetFeeEstimationAsync();
            feeData.FeeEstimations.Fees.Clear();
            feeData.FeeEstimations.Fees.AddRange(fetchFees);
            feeData.SelectedFeeEstimation = feeData.FeeEstimations.Fees.First();

            var accountBalanceInfo = await _walletUIService.RefreshWalletBalance();
            var accountInfo = accountBalanceInfo.AccountInfo;
            var words = await passwordComponent.GetWalletAsync();

            var investorPrivateKey = _derivationOperations.DeriveInvestorPrivateKey(words, project.ProjectInfo.FounderKey);

            var fromStage = StageInfo.Items.First(f => f.IsSpent == false);

            endOfProjectTransaction = _InvestorTransactionActions.RecoverEndOfProjectFunds(investmentTransaction.ToHex(network.Consensus.ConsensusFactory), project.ProjectInfo, fromStage.StageIndex,
                accountInfo.GetNextChangeReceiveAddress(), Encoders.Hex.EncodeData(investorPrivateKey.ToBytes()), feeData.SelectedFeeEstimation);

            Logger.LogInformation($"EndOfProjectTransactionId={endOfProjectTransaction.Transaction.GetHash().ToString()}");

            showEndOfProjectModal = true;
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            PrepareEndOfProjectCoinsModalSpinner = false;
        }

        StateHasChanged();
    }

    private async Task HandleEndOfProjectFeeChanged(FeeCalculation feeCalc)
    {
        if (!passwordComponent.HasPassword())
        {
            showEndOfProjectModal = false;
            notificationComponent.ShowErrorMessage("Wallet password expired");
            return;
        }

        try
        {
            if (feeCalc.UseCustomFee && feeCalc.CustomFee.HasValue)
            {
                feeData.SetCustomFee(feeCalc.CustomFee.Value);
            }
            else if (feeCalc.Position.HasValue && feeCalc.Position.Value <= feeData.FeeEstimations.Fees.Count)
            {
                feeData.SelectFee(feeCalc.Position.Value);
            }

            var words = await passwordComponent.GetWalletAsync();
            var accountInfo = storage.GetAccountInfo(network.Name);
            var investorPrivateKey = _derivationOperations.DeriveInvestorPrivateKey(words, project.ProjectInfo.FounderKey);
            var fromStage = StageInfo.Items.First(f => f.IsSpent == false);

            endOfProjectTransaction = _InvestorTransactionActions.RecoverEndOfProjectFunds(
                investmentTransaction.ToHex(network.Consensus.ConsensusFactory),
                project.ProjectInfo,
                fromStage.StageIndex,
                accountInfo.GetNextChangeReceiveAddress(),
                Encoders.Hex.EncodeData(investorPrivateKey.ToBytes()),
                feeData.SelectedFeeEstimation);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating fee");
            notificationComponent.ShowErrorMessage("Error calculating fee: " + ex.Message);
        }
    }

    private async Task EndOfProjectCoins()
    {
        PrepareEndOfProjectCoinsConfirmSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            showEndOfProjectModal = false;

            storage.UpdateInvestmentProject(project);

            Logger.LogInformation($"end of project trx hex = {endOfProjectTransaction.Transaction.ToHex(network.Consensus.ConsensusFactory)}");

            var response = await _WalletOperations.PublishTransactionAsync(network, endOfProjectTransaction.Transaction);

            if (!response.Success)
            {
                notificationComponent.ShowErrorMessage("Transaction failed", response.Message);
                return;
            }

            project.EndOfProjectTransactionId = endOfProjectTransaction.Transaction.GetHash().ToString();
            storage.UpdateInvestmentProject(project);

            _walletUIService.AddTransactionToPending(endOfProjectTransaction.Transaction);

            await RefreshInvestments();

            notificationComponent.ShowNotificationMessage("Transaction submitted successfully", 5);

        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            PrepareEndOfProjectCoinsConfirmSpinner = false;
            passwordComponent.ClearPassword();
        }
    }

    private void NavigatetoReleaseSigs()
    {
        NavigationManager.NavigateTo($"/release/{ProjectIdentifier}");
    }

    private void ShowMessageWithPassword()
    {
        // Set npub based on the project or recovery information
        if (project != null)
        {
            var investorProject = project as InvestorProject;
            npubValue = NostrHelper.ConvertHexToNpub(investorProject?.InvestorNPub ?? "") ?? investorProject?.InvestorNPub ?? "";

            founderNpub = NostrHelper.ConvertHexToNpub(investorProject.ProjectInfo.NostrPubKey) ??
                         investorProject.ProjectInfo.NostrPubKey;
                         
            // If password is available, get the private key
            if (passwordComponent.HasPassword())
            {
                _ = ShowMessage();
            }
            else
            {
                passwordComponent.ShowPassword(async () => {
                    await ShowMessage();
                });
            }
        }

        StateHasChanged();
    }

    private async Task ShowMessage()
    {
        showMessageModal = true;

        try
        {
            var words = await passwordComponent.GetWalletAsync();
            var privateKey = _derivationOperations.DeriveProjectNostrPrivateKey(words, project.ProjectInfo.FounderKey);
            currentUserPrivateKeyHex = Encoders.Hex.EncodeData(privateKey.ToBytes());
            hasMessges = false;
            project.LastRequestForMessagesTime = DateTime.UtcNow;
            storage.UpdateInvestmentProject(project);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            notificationComponent.ShowErrorMessage("Failed to initialize messaging", ex);
        }
    }
    
    private void OnMessageModalClose()
    {
        showMessageModal = false;
        currentUserPrivateKeyHex = String.Empty;
        StateHasChanged();
    }

    private void ShowNsecAndCheckPassword()
    {
        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(RetrieveAndShowNsec);
        }
        else
        {
            RetrieveAndShowNsec();
        }
    }

    private async Task RetrieveAndShowNsec()
    {
        try
        {
            var words = await passwordComponent.GetWalletAsync();

            if (project != null)
            {
                var privateKey = _derivationOperations.DeriveProjectNostrPrivateKey(words, project.ProjectInfo.FounderKey);
                var nostrHexSecKey = Encoders.Hex.EncodeData(privateKey.ToBytes());
                nsecValue = NostrHelper.ConvertHexToNsec(nostrHexSecKey)!;
                showNsec = true;
                StateHasChanged();
            }
            else
            {
                notificationComponent.ShowErrorMessage("Project information not available");
            }
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage("Failed to retrieve NSEC: " + e.Message);
        }
    }

    bool hasMessges = false;

    protected void ScanForDmMessages()
    {
        if (project != null)
        {
            _RelayService.LookupDirectMessagesForPubKey(
                project.InvestorNPub  ,
            project.LastRequestForMessagesTime?.AddSeconds(1),
                1,
                _ =>
                {
                    if (!string.IsNullOrEmpty(_.Pubkey))
                    {
                        hasMessges = true;
                        InvokeAsync(StateHasChanged);
                    }

                    return Task.CompletedTask;
                }, new[] { project.ProjectInfo.NostrPubKey });
        }
    }
}
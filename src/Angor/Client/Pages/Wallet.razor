@page "/wallet"

@using System.Text.Json
@using Angor.Client.Models
@using Angor.Client.Shared
@using Angor.Client.Storage
@using Angor.Shared
@using Angor.Shared.Models
@using Angor.Shared.Utilities
@using Blockcore.NBitcoin
@using Blockcore.Networks
@inject HttpClient _httpClient;
@inject IClientStorage storage;
@inject ICacheStorage _cacheStorage;
@inject IWalletStorage _walletStorage;
@inject ILogger<Wallet> Logger;
@inject IWalletOperations _walletOperations
@inject IClipboardService _clipboardService
@inject ICurrencyService _currencyService
@inject IDerivationOperations _derivationOperations
@inject NavMenuState NavMenuState
@inject IEncryptionService _encryptionService
@inject IClipboardService ClipboardService
@inject IWalletUIService _walletUIService

@inherits BaseComponent

<PageTitle>Wallet and balances</PageTitle>
<NotificationComponent @ref="notificationComponent" />
<PasswordComponent @ref="passwordComponent" />

<div class="header-container slide-in">
    <div class="card card-body">
        <div class="header-content">
            <div class="header-title animate-fade-in">
                <span class="header-icon-wrapper">
                    <Icon IconName="wallet" Width="32" Height="32" />
                </span>
                <h5 class="header-text">My Wallet</h5>
            </div>
            <div class="header-actions">
                @if (hasWallet)
                {
                    <button class="btn btn-border-warning" @onclick="() => walletWordsModal = true" data-cy="wallet-words" title="Wallet Seed">
                        <Icon IconName="wallet" Height="24" Width="24" />
                        <span class="button-text ms-2">View Seed</span>
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<!-- This part of the page is visible only if the wallet is not found -->
@if (!hasWallet)
{
    <!-- No Wallet found -->
    <div class="row">

        <div class="info-alert my-4 ">
            <Icon IconName="info" Class="alert-icon" Width="24" Height="24" />
            <p class="text-warning">
                No Wallet Available
            </p>
        </div>

    </div>
    <div class="row g-4 mt-4 d-flex justify-content-center text-center align-items-center slide-in">

        <div class="col-lg-3 col-sm-6 mt-lg-0 mt-4">
            <div class="card h-100 feature-box py-0">
                <div class="card-body d-flex flex-column justify-content-center text-center" @onclick="@(() => ShowCreateWalletModal("new"))" role="button">

                    <span class="mb-3" aria-hidden="true" data-cy="create-wallet">
                        <Icon IconName="add" Width="40" Height="40" />
                    </span>
                    <h5 class="text-nowrap">New Wallet</h5>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 mt-lg-0 mt-4">
            <div class="card h-100 feature-box py-0">
                <div class="card-body d-flex flex-column justify-content-center text-center align-items-center" data-cy="recover-wallet" @onclick="@(() => ShowCreateWalletModal("recover"))" role="button">
                    <span class="mb-3" aria-hidden="true">
                        <Icon IconName="recovery" Width="40" Height="40" />
                    </span>
                    <h5 class="text-nowrap">Import Wallet</h5>
                </div>
            </div>
        </div>
    </div>

    @if (walletWordsCreateModal)
    {
        <div class="modal-wrapper">
            <div class="modal fade show d-block" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content modern-modal">
                        <div class="modal-header border-0 pb-0">
                            <div class="d-flex align-items-center">
                                <Icon IconName="wallet" Height="32" Width="32" class="me-2" />
                                <h5 class="modal-title">@createWalletTitle - Step @currentStep of @totalSteps</h5>
                            </div>
                            <button class="btn-close-custom" @onclick="() => walletWordsCreateModal = false">
                                <Icon IconName="close-circle" Height="24" Width="24" />
                            </button>
                        </div>

                        <div class="modal-body modal-body-scroll py-4">
                            <div class="wallet-wizard">
                                @if (isNewWallet)
                                {
                                    @switch (currentStep)
                                    {
                                        case 1:
                                            <div class="info-card slide-in">

                                                <p class="text-muted mb-3">@stepDescription</p>
                                                <button class="btn btn-border-success w-100 mb-3" @onclick="GenerateNewWalletWords">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <Icon IconName="plus" Height="24" Width="24" Color="var(--angor-primary)" />
                                                        <span>Generate Recovery Phrase</span>
                                                    </div>
                                                </button>

                                                @if (!string.IsNullOrEmpty(newWalletWords))
                                                {
                                                    <div class="word-box-container">
                                                        @{
                                                            var words = newWalletWords.Split(' ');
                                                            for (int i = 0; i < words.Length; i++)
                                                            {
                                                                var index = i;
                                                                <div class="word-box">
                                                                    <span class="word-number">@(index + 1)</span>
                                                                    @words[index]
                                                                </div>
                                                            }
                                                        }
                                                    </div>
                                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mt-3">
                                                        <button class="btn btn-border w-100 w-md-auto" @onclick="CopyWalletWords">
                                                            <Icon IconName="copy" Height="20" Width="20" class="me-2" />
                                                            Copy
                                                        </button>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" @bind="backupConfirmation" id="backupCheck">
                                                            <label class="form-check-label" for="backupCheck">
                                                                I have safely backed up my recovery phrase
                                                            </label>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                            break;

                                        case 2:
                                            <div class="info-card slide-in">
                                                <p class="text-muted mb-5">@stepDescription</p>
                                                <div class="row g-4">
                                                    @for (int i = 0; i < selectedWordsToVerify.Count; i++)
                                                    {
                                                        var wordIndex = selectedWordsToVerify[i].index;
                                                        <div class="col-md-4 col-sm-6 mt-0">
                                                            <div class="mb-3 position-relative">
                                                                <label class="form-label">Word #@wordIndex</label>
                                                                <input type="text" class="form-control"
                                                                       value="@userVerificationInputs[wordIndex]"
                                                                       @oninput="(e) => HandleWordInput(wordIndex, e)"
                                                                       @onfocus="() => ShowSuggestionsIfNeeded(wordIndex)"
                                                                       placeholder="Enter word #@wordIndex" />
                                                                @if (invalidWordIndices.TryGetValue(wordIndex, out var isInvalid) && isInvalid)
                                                                {
                                                                    <div class="text-danger small mt-1">Not a valid BIP-39 word</div>
                                                                }
                                                                @if (showSuggestions.TryGetValue(wordIndex, out bool showForWord) &&
                                                               showForWord &&
                                                               !string.IsNullOrWhiteSpace(userVerificationInputs[wordIndex]))
                                                                {
                                                                    var suggestions = GetFilteredWordSuggestions(userVerificationInputs[wordIndex]);
                                                                    @if (suggestions.Any())
                                                                    {
                                                                        <div class="word-suggestions-dropdown">
                                                                            <div class="suggestions-container">
                                                                                @foreach (var suggestion in suggestions.Take(5))
                                                                                {
                                                                                    <div class="suggestion-item"
                                                                                         @onclick="() => SelectSuggestion(wordIndex, suggestion)"
                                                                                         @key="suggestion">
                                                                                        @suggestion
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                            break;

                                        case 3:
                                            <div class="info-card slide-in">

                                                <p class="text-muted mb-3">@stepDescription</p>
                                                <button class="btn btn-border-success w-100 mb-3" @onclick="ShowExtraWord">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <span class="me-1">
                                                            <Icon IconName="@(isPassphraseEnabled ? "shield-minus" : "shield-plus")"
                                                                  Height="24" Width="24" Color="var(--angor-primary)">
                                                            </Icon>
                                                        </span>
                                                        <span>Optional Passphrase</span>
                                                    </div>
                                                </button>

                                                @if (isPassphraseEnabled)
                                                {
                                                    <div class="mb-3">
                                                        <input type="text" class="form-control" placeholder="Enter passphrase"
                                                               @bind="passphraseInput">
                                                        <small class="text-muted">
                                                            A passphrase adds extra security. Make sure to remember it!
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                            break;

                                        case 4:
                                            <div class="info-card slide-in">

                                                <p class="text-muted mb-3">@stepDescription</p>
                                                <div class="input-group">
                                                    <input type="@passwordInputType" class="form-control"
                                                           @bind="newWalletPassword" placeholder="Enter password">
                                                    <button class="btn btn-border" @onclick="TogglePasswordVisibility">
                                                        @if (passwordToggleText == "Show")
                                                        {
                                                            <Icon IconName="visibility-off" Height="24" Width="24"></Icon>
                                                        }
                                                        else
                                                        {
                                                            <Icon IconName="visibility" Height="24" Width="24"></Icon>
                                                        }
                                                    </button>
                                                </div>
                                            </div>
                                            break;
                                    }
                                }
                                else
                                {
                                    @switch (currentStep)
                                    {
                                        case 1:
                                            <div class="info-card slide-in">

                                                <p class="text-muted mb-3">@stepDescription</p>
                                                <textarea class="form-control" rows="3" placeholder="Enter your wallet words"
                                                    @bind="newWalletWords" @oninput="OnImportWordsInput"></textarea>
                                                @if (!string.IsNullOrWhiteSpace(newWalletWords))
                                                {
                                                    var words = newWalletWords.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
                                                    <div class="mt-2">
                                                        @for (int i = 0; i < words.Length; i++)
                                                        {
                                                            var word = words[i];
                                                            var isInvalid = !NBitcoin.Wordlist.English.GetWords().Contains(word.ToLowerInvariant());
                                                            <span class="badge @(isInvalid ? "bg-danger" : "bg-success") m-1">@word</span>
                                                        }
                                                    </div>
                                                    @if (words.Any(w => !NBitcoin.Wordlist.English.GetWords().Contains(w.ToLowerInvariant())))
                                                    {
                                                        <div class="text-danger mt-1">One or more words are not valid BIP-39 words.</div>
                                                    }
                                                }
                                            </div>
                                            break;

                                        case 2:
                                            <div class="info-card slide-in">

                                                <p class="text-muted mb-3">@stepDescription</p>
                                                <button class="btn btn-border-success w-100 mb-3" @onclick="ShowExtraWord">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <span class="me-1">
                                                            <Icon IconName="@(isPassphraseEnabled ? "shield-minus" : "shield-plus")"
                                                                  Height="24" Width="24" Color="var(--angor-primary)">
                                                            </Icon>
                                                        </span>
                                                        <span>Optional Passphrase</span>
                                                    </div>
                                                </button>

                                                @if (isPassphraseEnabled)
                                                {
                                                    <input type="text" class="form-control" placeholder="Enter your passphrase"
                                                           @bind="passphraseInput">
                                                }
                                            </div>
                                            break;

                                        case 3:
                                            <div class="info-card slide-in">

                                                <p class="text-muted mb-3">@stepDescription</p>
                                                <div class="input-group">
                                                    <input type="@passwordInputType" class="form-control"
                                                           @bind="newWalletPassword" placeholder="Enter password">
                                                    <button class="btn btn-border" @onclick="TogglePasswordVisibility">

                                                        @if (passwordToggleText == "Show")
                                                        {
                                                            <Icon IconName="visibility-off" Height="24" Width="24"></Icon>
                                                        }
                                                        else
                                                        {
                                                            <Icon IconName="visibility" Height="24" Width="24"></Icon>
                                                        }

                                                    </button>
                                                </div>
                                            </div>
                                            break;
                                    }
                                }
                            </div>
                        </div>

                        <div class="modal-footer border-0 pt-0">
                            <div class="d-flex flex-column flex-md-row justify-content-between w-100">
                                @if (network.NetworkType == NetworkType.Testnet && currentStep == 2 && isNewWallet)
                                {
                                    <div class="order-1 order-md-0">
                                        <button class="btn btn-border-warning w-100 w-md-auto" @onclick="SkipVerification">
                                            Skip Verification
                                        </button>
                                    </div>
                                    <div class="d-flex flex-column flex-md-row gap-2 order-0 order-md-1">
                                        @if (currentStep > 1)
                                        {
                                            <button class="btn btn-border order-1 order-md-0" @onclick="PreviousStep">Back</button>
                                        }
                                        <button class="btn btn-border-success order-0 order-md-1" @onclick="NextStep" disabled="@(!CanProceedToNextStep())">
                                            Next
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex flex-column flex-md-row justify-content-md-end w-100 gap-2">
                                        @if (currentStep > 1)
                                        {
                                            <button class="btn btn-border order-1 order-md-0" @onclick="PreviousStep">Back</button>
                                        }

                                        @if (currentStep < totalSteps)
                                        {
                                            <button class="btn btn-border-success order-0 order-md-1" @onclick="NextStep"
                                                    disabled="@(!CanProceedToNextStep())">
                                                Next
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-border-success order-0 order-md-1" @onclick="CreateWalletAsync"
                                                    disabled="@(!CanCreateWallet())">
                                                @if (createWalletSpinner)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                                }
                                                @(isNewWallet ? "Create Wallet" : "Recover Wallet")
                                            </button>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (walletWordsModal)
    {
        <div class="modal-wrapper">
            <div class="modal fade show d-block" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content modern-modal">
                        <div class="modal-header border-0 pb-0">
                            <div class="d-flex align-items-center">
                                <Icon IconName="wallet" Height="32" Width="32" class="me-2" />
                                <h5 class="modal-title">Backup Recovery Phrase</h5>
                            </div>
                            <button class="btn-close-custom" @onclick="() => walletWordsModal = false">
                                <Icon IconName="close-circle" Height="24" Width="24" />
                            </button>
                        </div>

                        <div class="modal-body modal-body-scroll py-4">
                            <div class="transaction-info-section row">
                                <div class="col-12 col-md-6 mb-3">
                                    <div class="info-label">Password</div>
                                    <input type="password" class="form-control" @bind="showWalletPassword" placeholder="Enter password">
                                    @if (!string.IsNullOrEmpty(showWalletPasswordError))
                                    {
                                        <div class="alert alert-danger mt-2">@showWalletPasswordError</div>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(showWalletWords))
                                {
                                    <div class="col-12 col-md-6 mb-3">
                                        <div class="info-label">Recovery Phrase</div>
                                        <textarea class="form-control" @bind="showWalletWords" rows="3" readonly></textarea>
                                    </div>
                                    <div class="col-12 col-md-6 mb-3">
                                        <div class="info-label">Passphrase</div>
                                        <input type="text" class="form-control" @bind="showWalletWordsPassphrase" readonly>
                                    </div>
                                    <div class="col-12 mt-2">
                                        <button class="btn btn-border-success w-100 w-md-auto" @onclick="CopyWordsToClibboard">
                                            Copy to Clipboard
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="modal-footer border-0 pt-0">
                            <button class="btn btn-border-success w-100 w-md-auto" @onclick="ShowWords" disabled="@createWalletSpinner">
                                @if (createWalletSpinner)
                                {
                                    <span class=" spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Loading...</span>
                                }
                                else
                                {
                                    <span>View Seed</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <!-- Section 1 -->
    <div class="row mt-4">

        <div class="header-container slide-in">
            <div class="card card-body">
                <div class="header-content">
                    <div class="header-title animate-fade-in">
                        <span class="header-icon-wrapper">
                            <Icon IconName="balance" Width="32" Height="32" />
                        </span>
                        <div class="wallet-balance">
                            <BalanceDisplay BtcBalance="@Money.Satoshis(accountBalanceInfo.TotalBalance).ToUnit(MoneyUnit.BTC)"
                                            BtcBalanceInFiat="@btcBalanceInUsd"
                                            PreferredCurrency="@storage.GetCurrencyDisplaySetting()"
                                            ShowFiatInline="true" />
                        </div>
                    </div>
                    <div class="header-actions">
                        @if (CanGetTestCoins())
                        {
                            <button class="btn btn-border-warning"
                                    data-cy="get-test-coins"
                                    @onclick="GetTestCoins"
                                    disabled="@testCoinsSpinner">
                                @if (testCoinsSpinner)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                }
                                else
                                {
                                    <Icon IconName="balance" Height="24" Width="24" />
                                    <span class="button-text ms-2">Get Test Coins</span>
                                }
                            </button>
                        }
                        <button class="btn btn-border-success"
                                @onclick="RefreshBalance"
                                disabled="@balanceSpinner">
                            @if (balanceSpinner)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            }
                            else
                            {
                                <Icon IconName="refresh" Height="24" Width="24" />
                                <span class="button-text ms-2">Refresh</span>
                            }
                        </button>
                    </div>
                </div>
                @if (accountBalanceInfo.TotalUnconfirmedBalance > 0 || accountBalanceInfo.TotalBalanceReserved > 0)
                {
                    <div class="wallet-details">
                        @if (accountBalanceInfo.TotalUnconfirmedBalance > 0)
                        {
                            <div class="balance-info">
                                <p class="balance-label" data-cy="unconfirmed-balance">Pending Balance</p>
                                <h6 class="balance-value">
                                    @Money.Satoshis(accountBalanceInfo.TotalUnconfirmedBalance).ToUnit(MoneyUnit.BTC)
                                    @network.CoinTicker
                                </h6>
                            </div>
                        }

                        @if (accountBalanceInfo.TotalBalanceReserved > 0)
                        {
                            <div class="balance-info">
                                <p class="balance-label" data-cy="reserved-balance">Reserved Balance</p>
                                <h6 class="balance-value">
                                    @Money.Satoshis(accountBalanceInfo.TotalBalanceReserved).ToUnit(MoneyUnit.BTC)
                                    @network.CoinTicker
                                </h6>
                            </div>
                        }
                    </div>
                }


            </div>
        </div>

        @if (walletWordsModal)
        {
            <!-- Wallet Words Modal -->
            <div class="modal-wrapper">
                <div class="modal fade show d-block" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content modern-modal">
                            <div class="modal-header border-0 pb-0">
                                <div class="d-flex align-items-center">
                                    <Icon IconName="key" Height="32" Width="32" class="me-2" />
                                    <h5 class="modal-title">Wallet Seed</h5>
                                </div>
                                <button class="btn-close-custom" @onclick="() => { WalletWordsClose(); walletWordsModal = false; }">
                                    <Icon IconName="close-circle" Height="24" Width="24" />
                                </button>
                            </div>

                            <div class="modal-body modal-body-scroll py-4">
                                @if (string.IsNullOrEmpty(showWalletWords))
                                {
                                    <div class="mb-1">
                                        <label class="mb-3">Please enter your wallet password:</label>
                                        <div class="input-group">
                                            <input type="@passwordInputType"
                                                   class="form-control"
                                                   @bind="showWalletPassword"
                                                   @bind:event="oninput"
                                                   @onkeypress="@(async e => { if(e.Key is "Enter" or "NumpadEnter") await ShowWords(); })" />
                                            <button class="btn btn-border" type="button" @onclick="TogglePasswordVisibility">
                                                @if (passwordToggleText == "Show")
                                                {
                                                    <Icon IconName="visibility-off" Height="24" Width="24"></Icon>
                                                }
                                                else
                                                {
                                                    <Icon IconName="visibility" Height="24" Width="24"></Icon>
                                                }
                                            </button>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(showWalletPasswordError))
                                    {
                                        <div class="text-danger">@showWalletPasswordError</div>
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-danger text-white" role="alert" data-cy="alert-wallet-words">
                                        <p>@showWalletWords</p>
                                        <div class="mt-3 d-flex justify-content-end">
                                            <i @onclick="CopyWordsToClibboard" class="ms-auto cursor-pointer user-select-none">
                                                <Icon IconName="copy" />
                                            </i>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(showWalletWordsPassphrase))
                                    {
                                        <p>This wallet has a passphrase!</p>
                                    }
                                }
                            </div>

                            <div class="modal-footer border-0 pt-0">
                                <button class="btn btn-border-danger" @onclick="ShowWords" data-cy="wallet-words-in-popup">View Seed</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }


    </div>


    <!-- Section 2 -->
    <div class="row mt-4">
        <div class="tab-container">
            <div class="tabs-wrapper">
                <div class="tab-item @(activeTab == 1 ? "active" : "")" @onclick="() => SetActiveTab(1)" data-cy="send-tab">
                    <div class="tab-content">
                        <div class="tab-icon @(activeTab == 1 ? "heartbeat" : "")" aria-hidden="true">
                            <Icon IconName="send" Height="32" Width="32" />
                        </div>
                        <span class="tab-label">Send</span>
                    </div>
                </div>

                <div class="tab-item @(activeTab == 2 ? "active" : "")" @onclick="() => SetActiveTab(2)" data-cy="receive-tab">
                    <div class="tab-content">
                        <div class="tab-icon @(activeTab == 2 ? "heartbeat" : "")" aria-hidden="true">
                            <Icon IconName="receive" Height="32" Width="32" />
                        </div>
                        <span class="tab-label">Receive</span>
                    </div>
                </div>

                <div class="tab-item @(activeTab == 3 ? "active" : "")" @onclick="() => SetActiveTab(3)" data-cy="history-tab">
                    <div class="tab-content">
                        <div class="tab-icon @(activeTab == 3 ? "heartbeat" : "")" aria-hidden="true">
                            <Icon IconName="calculator" Height="32" Width="32" />
                        </div>
                        <span class="tab-label">Addresses</span>
                    </div>
                </div>
            </div>
        </div>
        <br />
        @if (activeTab == 1)
        {
            <!-- Section 3 -->
            <div class="col-md-12">

                <div class="card card-body mt-4">

                    <div class="d-flex align-items-center">
                        <span class="user-select-none animate-rotate">
                            <Icon IconName="send"></Icon>
                        </span>
                        <div class="h-100 ms-3">
                            <h5 class="mb-0 font-weight-bolder">
                                Send
                            </h5>
                        </div>
                    </div>

                    <div class="row mt-4">

                        <form>
                            <div class="mb-3">
                                <label for="sendToAddress" class="form-label">Send to Address</label>
                                <div class="input-group">
                                    <span role="button" class="btn btn-border-success" @onclick="PasteFromClipboard">
                                        <Icon IconName="paste" />
                                    </span>

                                    <input type="text" class="form-control" id="sendToAddress" @bind="_sendInfo.SendToAddress" placeholder="Enter address">


                                    <span role="button" class="btn btn-border-danger" @onclick="ClearAddress">
                                        <Icon IconName="remove" />
                                    </span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="sendAmount" class="form-label">Amount</label>
                                <input type="number" step="0.00000001" min="0" class="form-control" id="sendAmount"
                                       @bind-value="sendAmount" @bind-value:event="oninput"
                                       placeholder="Enter amount">
                            </div>

                            <div class="d-flex align-items-center">
                                <!-- Select UTXOs Button -->
                                <button type="button" class="btn btn-border-success me-3"
                                        @onclick="() => coinControlModal = true">
                                    Select UTXOs

                                    @if (_sendInfo.SendUtxos.Any())
                                    {
                                        <span class="badge text-bg-warning ms-3">
                                            @_sendInfo.SendUtxos.Count
                                        </span>
                                    }
                                </button>

                                <!-- Send Button with Confirmation Dialog -->
                                <button type="button" class="btn btn-border-success"
                                        data-cy="send-button" @onclick="AskPassword"
                                        disabled="@sendLoadSpinner">
                                    @if (sendLoadSpinner)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"
                                              role="status" aria-hidden="true">
                                        </span>
                                        <span>Sending...</span>
                                    }
                                    else
                                    {
                                        <span>Send</span>
                                    }
                                </button>
                            </div>

                        </form>
                    </div>
                </div>

                @if (coinControlModal)
                {
                    <div class="modal-wrapper">
                        <div class="modal fade show d-block" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content modern-modal">
                                    <div class="modal-header border-0 pb-0">
                                        <div class="d-flex align-items-center">
                                            <Icon IconName="utxo" Height="32" Width="32" class="me-2" />
                                            <h5 class="modal-title">Select UTXOs</h5>
                                        </div>
                                        <button class="btn-close-custom" @onclick="() => coinControlModal = false">
                                            <Icon IconName="close-circle" Height="24" Width="24" />
                                        </button>
                                    </div>

                                    <div class="modal-body modal-body-scroll py-4">
                                        <div class="transaction-info-section mb-4">
                                            <p class="pb-4">Total amount selected = @Money.Satoshis(_sendInfo.SendUtxos.Sum(s => s.Value.UtxoData.value)).ToUnit(MoneyUnit.BTC) @network.CoinTicker</p>
                                            @foreach (var addressInfo in accountBalanceInfo.AccountInfo.AddressesInfo.Union(accountBalanceInfo.AccountInfo.ChangeAddressesInfo))
                                            {
                                                foreach (var addressUtxoItem in addressInfo.UtxoData)
                                                {
                                                    var outpointStr = addressUtxoItem.outpoint.ToString();
                                                    var outpointLength = outpointStr.Length;
                                                    var shortenedOutpoint = outpointLength > 20
                                                    ? $"{outpointStr.Substring(0, 10)} ... {outpointStr.Substring(outpointLength - 10)}"
                                                    : outpointStr;

                                                    var valueInBTC = Money.Satoshis(addressUtxoItem.value).ToUnit(MoneyUnit.BTC);
                                                    var coinTicker = network.CoinTicker;
                                                    var isTicked = _sendInfo.SendUtxos.ContainsKey(outpointStr);

                                                    <div class="info-card mb-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="@outpointStr" @bind="@isTicked" @onclick="() => HandleCheckboxChange(addressUtxoItem, addressInfo.HdPath)">
                                                            <label class="form-check-label" for="@outpointStr">
                                                                @($"{shortenedOutpoint} - {valueInBTC} {coinTicker}")
                                                            </label>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>

                                    <div class="modal-footer border-0">
                                        <button class="btn btn-border-success" @onclick="() => coinControlModal = false">Submit</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (sendConfirmModal)
                {
                    <!-- Send Confirmation Modal -->
                    <div class="modal-wrapper">
                        <div class="modal fade show d-block" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content modern-modal">
                                    <div class="modal-header border-0 pb-0">
                                        <div class="d-flex align-items-center">
                                            <Icon IconName="utxo" Height="32" Width="32" class="me-2" />
                                            <h5 class="modal-title">Transaction Details</h5>
                                        </div>
                                        <button class="btn-close-custom" @onclick="() => sendConfirmModal = false" disabled="@sendConfirmSpinner">
                                            <Icon IconName="close-circle" Height="24" Width="24" />
                                        </button>
                                    </div>

                                    <div class="modal-body modal-body-scroll">
                                        <div class="transaction-details mb-4">
                                            <div class="info-card p-3 rounded">
                                                <div class="d-flex flex-column gap-3">
                                                    <div class="info-row d-flex flex-column">
                                                        <span class="text-muted small mb-1">Amount</span>
                                                        <span class="amount fw-bold text-break">
                                                            @_sendInfo.SendAmount.ToUnitBtc() @network.CoinTicker
                                                        </span>
                                                    </div>

                                                    <div class="info-row d-flex flex-column">
                                                        <span class="text-muted small mb-1">Destination Address</span>
                                                        <span class="address text-break" style="word-break: break-all;">
                                                            @_sendInfo.SendToAddress
                                                        </span>
                                                    </div>

                                                    <div class="info-row d-flex flex-column">
                                                        <span class="text-muted small mb-1">Change Address</span>
                                                        <span class="address text-break" style="word-break: break-all;">
                                                            @_sendInfo.ChangeAddress
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <FeeSelector SendFee="@_sendInfo.SendFee"
                                                     CoinTicker="@network.CoinTicker"
                                                     FeeRate="@_sendInfo.FeeRate"
                                                     FeeBlockCount="@_sendInfo.FeeBlockCount"
                                                     FeePosition="@FeePosition"
                                                     FeeMin="@FeeMin"
                                                     FeeMax="@_feeMax"
                                                     RecommendedMinFee="@GetRecommendedMinFee()"
                                                     OnFeeChanged="@HandleFeeChanged"></FeeSelector>
                                        @if (_sendInfo.SendUtxos.Any())
                                        {
                                            <div class="info-card utxo-details p-3 rounded mt-4">
                                                <h6 class="mb-3">Selected UTXOs</h6>
                                                <div class="utxo-list">
                                                    @foreach (var infoSendUtxo in _sendInfo.SendUtxos)
                                                    {
                                                        var outpointStr = infoSendUtxo.Key;
                                                        var shortenedOutpoint = outpointStr.Length > 20
                                                        ? $"{outpointStr[..10]}...{outpointStr[^10..]}"
                                                        : outpointStr;

                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <span class="text-muted text-truncate me-2" title="@outpointStr">@shortenedOutpoint</span>
                                                            <span class="fw-bold text-nowrap">
                                                                @Money.Satoshis(infoSendUtxo.Value.UtxoData.value).ToUnit(MoneyUnit.BTC) @network.CoinTicker
                                                            </span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="modal-footer border-0 pt-0">
                                        <div class="d-flex flex-column flex-md-row justify-content-end gap-2 w-100">
                                            <button class="btn btn-border order-3 order-md-1" @onclick="ShowTransactionJson">
                                                View Details
                                            </button>
                                            <button type="button" class="btn btn-border-warning order-2"
                                                    @onclick="() => sendConfirmModal = false"
                                                    disabled="@sendConfirmSpinner">
                                                Cancel
                                            </button>
                                            <button type="button" class="btn btn-border-success order-1 order-md-3"
                                                    @onclick="SendCoins"
                                                    disabled="@sendConfirmSpinner">
                                                @if (sendConfirmSpinner)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                    <span>Sending...</span>
                                                }
                                                else
                                                {
                                                    <span>Confirm</span>
                                                }
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        @if (activeTab == 2)
        {
            <div class="col-md-12">

                <div class="card card-body mt-4">

                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div class="d-flex align-items-center">
                            <span class="user-select-none animate-rotate">
                                <Icon IconName="receive"></Icon>
                            </span>
                            <div class="h-100 ms-3">
                                <h5 class="mb-0 font-weight-bolder">
                                    Receive
                                </h5>
                            </div>

                        </div>
                        <ShowQrCode @ref="showQrCode" Data="@accountBalanceInfo.AccountInfo.GetNextReceiveAddress()" />

                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12 mb-md-0 mb-4">
                            <div class="info-card p-3">
                                <div class="d-flex align-items-center">
                                    <img class="me-3 flex-shrink-0" src="/assets/img/bitcoin.svg" alt="Bitcoin" style="width: 24px; height: 24px;">
                                    <div class="overflow-auto flex-grow-1 me-2" style="white-space: nowrap; min-width: 0;">
                                        <span class="text-break fw-bold" style="font-size: 14px;">@accountBalanceInfo.AccountInfo.GetNextReceiveAddress()</span>
                                    </div>
                                    <button class="btn btn-sm btn-border ms-2 flex-shrink-0" @onclick="CopyNextReceiveAddress" data-cy="SHOW_QR_CODE_WALLET">
                                        <Icon IconName="copy" Width="18" Height="18" />
                                        <span class="d-none d-md-inline ms-1">Copy</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        @if (activeTab == 3)
        {
            <div class="col-md-12">
                <div class="card card-body mt-4">
                    <div class="d-flex align-items-center">
                        <span class="user-select-none animate-rotate">
                            <Icon IconName="calculator"></Icon>
                        </span>
                        <div class="h-100 ms-3">
                            <h5 class="mb-0 font-weight-bolder">
                                Addresses and Amounts
                            </h5>
                        </div>
                    </div>
                    <div class="table-responsive form-control mt-4 slide-in">
                        @if (accountBalanceInfo.AccountInfo.AllAddresses().Any(address => address.Balance > 0))
                        {
                            <table class="table align-items-center mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-uppercase text-xxs font-weight-bolder opacity-7" scope="col">Address</th>
                                        <th class="text-uppercase text-xxs font-weight-bolder opacity-7" scope="col">Amount</th>
                                        <th class="text-uppercase text-xxs font-weight-bolder opacity-7" scope="col">Path</th>
                                        <th class="text-uppercase text-xxs font-weight-bolder opacity-7" scope="col">UTXO count</th>
                                        <th class="text-uppercase text-xxs font-weight-bolder opacity-7" scope="col">View Raw Json</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var addressInfo in accountBalanceInfo.AccountInfo.AllAddresses())
                                    {
                                        var total = addressInfo.Balance;
                                        var count = addressInfo.UtxoData.Count();

                                        if (total > 0)
                                        {
                                            <tr @onclick="() => ToggleCollapse(addressInfo.Address)" class="clickable-row" data-cy="adress-row" aria-expanded="@IsExpanded(addressInfo.Address).ToString().ToLower()" aria-controls="@($"collapse-{addressInfo.Address}")">
                                                <td>@addressInfo.Address</td>
                                                <td>@Money.Satoshis(total).ToUnit(MoneyUnit.BTC) @network.CoinTicker</td>
                                                <td>@addressInfo.HdPath</td>
                                                <td>@count</td>
                                                <td>
                                                    <button class="btn btn-border-success" @onclick="() => ShowRawTransactionJson(addressInfo)">Show</button>
                                                </td>
                                            </tr>
                                            @if (IsExpanded(addressInfo.Address))
                                            {
                                                <tr>
                                                    <td colspan="5">
                                                        <div class="collapse show" data-cy="expend-amount" id="@($"collapse-{addressInfo.Address}")">
                                                            <div class="card card-body">
                                                                <!-- Inner table goes here -->
                                                                <div class="table-responsive form-control">
                                                                    <table class="table table-sm">
                                                                        <thead>
                                                                            <tr>
                                                                                <th scope="col">Coin</th>
                                                                                <th scope="col">Amount</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            @foreach (var addressUtxoItem in addressInfo.UtxoData)
                                                                            {
                                                                                <tr>
                                                                                    <td>@($"{addressUtxoItem.outpoint}")</td>
                                                                                    <td>@Money.Satoshis(addressUtxoItem.value).ToUnit(MoneyUnit.BTC) @network.CoinTicker</td>
                                                                                </tr>
                                                                            }
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="text-center">
                                <p class="text-muted">No addresses or amounts to display.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <RawTransactionModal RawTransactionJson="@rawTransactionJson" IsVisible="@showRawTransactionModal" IsVisibleChanged="HandleModalVisibility" />
    <RawTransactionModal RawTransactionJson="@transactionJson" IsVisible="@showTransactionJsonModal" IsVisibleChanged="HandleTransactionJsonModalVisibility" />
}


@code {


    private bool balanceSpinner;
    private bool createWalletSpinner;
    private bool testCoinsSpinner;
    private bool sendLoadSpinner;
    private bool sendConfirmSpinner;

    private string? showWalletWords;
    private string? showWalletWordsPassphrase;
    private string? showWalletPassword;
    private string? showWalletPasswordError;

    private string? newWalletWords;
    private string? newWalletWordsPassphrase;
    private string? newWalletPassword;
    private string passwordInputType = "password";
    private string passwordToggleText = "Show";

    private bool isNewWallet;
    private string createWalletTitle = "Create Wallet";
    private string createWalletDescription = "Generate a new wallet";

    private bool sendConfirmModal;
    private bool coinControlModal;
    private bool walletWordsModal;
    private bool walletWordsCreateModal;

    private bool backupConfirmation;
    private bool showBackupConfirmationError;

    private int activeTab = 1;


    private int feeRange = 0;
    private int FeePosition = 1;
    private SendInfo _sendInfo = new();

    private bool showRawTransactionModal;
    private string rawTransactionJson = string.Empty;
    private string transactionJson;
    private bool showTransactionJsonModal = false;

    private bool showPassphraseInput = false;
    private readonly AccountBalanceInfo accountBalanceInfo = new();

    private readonly FeeEstimations FeeEstimations = new();

    // Max index for the range input
    private readonly int FeeMin = 1;
    private int _feeMax = 3;

    DateTime _lastFeeRefresh = DateTime.MinValue;

    ShowQrCode showQrCode;

    readonly Dictionary<string, bool> collapseStates = new();
    private string btcBalanceInUsd;
    private readonly Dictionary<string, string> fiatValues = new();

    private int currentStep = 1;
    private int totalSteps => isNewWallet ? 4 : 3;
    private bool isPassphraseEnabled;
    private string? passphraseInput;
    private string stepTitle => GetStepTitle();
    private string stepDescription => GetStepDescription();

    private List<(int index, string word)> selectedWordsToVerify = new();
    private Dictionary<int, string> userVerificationInputs = new();
    private bool verificationPassed;
    private bool showVerificationError;
    private List<(int originalIndex, int shuffledIndex)> shuffledWordIndices = new();

    private Dictionary<int, bool> showSuggestions = new();

    private Dictionary<int, bool> invalidWordIndices = new();

    private decimal sendAmount
    {
        get => Money.Satoshis(_sendInfo.SendAmount).ToUnit(MoneyUnit.BTC);
        set => _sendInfo.SendAmount = Money.Coins(value).Satoshi;
    }

    private string GetStepTitle()
    {
        if (isNewWallet)
        {
            return currentStep switch
            {
                1 => "Generate Wallet Words",
                2 => "Verify Your Backup",
                3 => "Optional Security",
                4 => "Set Password",
                _ => string.Empty
            };
        }

        return currentStep switch
        {
            1 => "Enter Wallet Words",
            2 => "Optional Security",
            3 => "Set Password",
            _ => string.Empty
        };
    }

    private string GetStepDescription()
    {
        if (isNewWallet)
        {
            return currentStep switch
            {
                1 => "Generate and backup your wallet words",
                2 => "Verify your backed up words",
                3 => "Add an optional passphrase",
                4 => "Set a password to protect your wallet",
                _ => string.Empty
            };
        }

        return currentStep switch
        {
            1 => "Enter your existing wallet words",
            2 => "Enter your passphrase if you used one",
            3 => "Set a password to protect your wallet",
            _ => string.Empty
        };
    }

    private void NextStep()
    {
        if (currentStep == 1 && isNewWallet)
        {
            if (!backupConfirmation)
            {
                notificationComponent.ShowNotificationMessage("Please confirm that you have written down your wallet words.");
                return;
            }

            PrepareFullVerification();
            showVerificationError = false; // Reset error state
        }
        else if (currentStep == 2 && isNewWallet)
        {
            if (!verificationPassed)
            {
                notificationComponent.ShowNotificationMessage("Please correctly enter all recovery words to proceed.");
                return;
            }
        }

        if (currentStep < totalSteps)
        {
            currentStep++;
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }
    private bool AnyWordInvalid() => invalidWordIndices.Values.Any(v => v);

    private bool CanProceedToNextStep()
    {
        return currentStep switch
        {
            1 => !string.IsNullOrWhiteSpace(newWalletWords) && (isNewWallet ? backupConfirmation : true),
            2 => isNewWallet ? verificationPassed : true,
            3 => true,
            _ => false
        } 
       // && !AnyWordInvalid();
    }

    private bool CanCreateWallet()
    {
        if (string.IsNullOrWhiteSpace(newWalletPassword))
            return false;

        if (isNewWallet && !backupConfirmation)
            return false;

        return true;
    }

    protected override async Task OnInitializedAsync()
    {
        if (hasWallet)
        {
            var accountInfo = storage.GetAccountInfo(network.Name);
            var unconfirmedInfo = _cacheStorage.GetUnconfirmedInboundFunds();
            accountBalanceInfo.UpdateAccountBalanceInfo(accountInfo, unconfirmedInfo);
            btcBalanceInUsd = await GetBtcValueInPreferredCurrency(accountBalanceInfo.TotalBalance);
            await PrecomputeFiatValues();
        }

        await base.OnInitializedAsync();
    }


    private async Task RefreshBalance()
    {
        if (!balanceSpinner)
        {
            balanceSpinner = true;

            try
            {
                await _walletUIService.RefreshWalletBalance(accountBalanceInfo);

                showQrCode?.SetQRCode(accountBalanceInfo.AccountInfo.GetNextReceiveAddress());
            }
            catch (Exception e)
            {
                notificationComponent.ShowErrorMessage(e.Message, e);
            }
            finally
            {
                balanceSpinner = false;
                notificationComponent.ShowNotificationMessage("Balance refreshed successfully!");
            }
        }
    }

    private async Task ShowCreateWalletModal(string type)
    {
        // Reset all state first
        ResetWalletCreationState();

        // Then set new wallet type
        isNewWallet = type == "new";
        createWalletTitle = isNewWallet ? "Create Wallet" : "Recover Wallet";
        createWalletDescription = isNewWallet ? "Generate a new wallet" : "Paste your wallet words";

        walletWordsCreateModal = true;
        StateHasChanged();
        await Task.Delay(10);
    }

    private void TogglePasswordVisibility()
    {
        if (passwordInputType == "password")
        {
            passwordInputType = "text";
            passwordToggleText = "Hide";
        }
        else
        {
            passwordInputType = "password";
            passwordToggleText = "Show";
        }
    }

    private async Task CreateWalletAsync()
    {
        if (string.IsNullOrEmpty(newWalletWords))
        {
            //walletWordsCreateModal = false;
            notificationComponent.ShowErrorMessage(
                isNewWallet
                    ? "You need to generate your wallet words before continuing."
                    : "Please enter or paste your wallet words to recover your wallet."
            );
            return;
        }

        if (string.IsNullOrEmpty(newWalletPassword))
        {
            //walletWordsCreateModal = false;
            notificationComponent.ShowErrorMessage("Don't forget to set a password for your wallet!");
            return;
        }

        // Only check backup confirmation for new wallets, not recovery
        if (isNewWallet && !backupConfirmation)
        {
            //showBackupConfirmationError = true;
            notificationComponent.ShowErrorMessage("Before you continue, please confirm that you've safely written down your wallet words.");
            return;
        }


        createWalletSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            // Validate wallet words format for recovery
            if (!isNewWallet && !ValidateWalletWords(newWalletWords))
            {
                throw new Exception("Invalid wallet words format. Please check your backup and try again.");
            }

            var data = new WalletWords { Words = newWalletWords.Trim(), Passphrase = newWalletWordsPassphrase };
            var accountInfo = _walletOperations.BuildAccountInfoForWalletWords(data);
            await _walletOperations.UpdateAccountInfoWithNewAddressesAsync(accountInfo);

            var encrypted = await _encryptionService.EncryptData(data.ConvertToString(), newWalletPassword);

            _walletStorage.SaveWalletWords(new Angor.Shared.Models.Wallet { EncryptedData = encrypted });
            storage.SetAccountInfo(network.Name, accountInfo);
            accountBalanceInfo.UpdateAccountBalanceInfo(accountInfo, new List<UtxoData>());

            // pre-derive the angor wallet keys
            var founderKeyCollection = _derivationOperations.DeriveProjectKeys(data, _networkConfiguration.GetAngorKey());
            _walletStorage.SetFounderKeys(founderKeyCollection);

            hasWallet = _walletStorage.HasWallet();
            ClearWalletWords();

            walletWordsCreateModal = false;

            NavMenuState.NotifyStateChanged();

            notificationComponent.ShowNotificationMessage(isNewWallet ? "Wallet created successfully!" : "Wallet recovered successfully!");
        }
        catch (Exception e)
        {
            walletWordsCreateModal = false;
            notificationComponent.ShowErrorMessage($"Error: {e.Message}", e);
        }
        finally
        {
            createWalletSpinner = false;
        }
    }

    private bool ValidateWalletWords(string words)
    {
        if (string.IsNullOrWhiteSpace(words))
            return false;

        var wordsList = words.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);

        // Most HD wallets use 12 or 24 words
        return wordsList.Length == 12 || wordsList.Length == 24;
    }

    private async Task ShowWords()
    {
        if (string.IsNullOrEmpty(showWalletPassword))
        {
            notificationComponent.ShowNotificationMessage("Wallet password is null or empty");
            //throw new ArgumentNullException(nameof(showWalletPassword));
            return;
        }


        var wallet = _walletStorage.GetWallet();
        var walletData = await _encryptionService.DecryptData(wallet.EncryptedData, showWalletPassword);

        if (string.IsNullOrEmpty(walletData))
        {
            // invalid password
            showWalletPasswordError = "Invaid password";
            return;
        }

        var data = WalletWords.ConvertFromString(walletData);
        showWalletWords = data.Words;
        showWalletWordsPassphrase = data.Passphrase;
        data = null;
        StateHasChanged();
    }

    private async Task CopyWordsToClibboard()
    {
        if (string.IsNullOrEmpty(showWalletWords))
        {
            throw new InvalidOperationException();
        }

        await _clipboardService.WriteTextAsync(showWalletWords);
        ClearWalletWords();
        StateHasChanged();
    }

    private void ClearWalletWords()
    {
        showWalletWords = null;
        showWalletWordsPassphrase = null;
        newWalletWords = null;
        newWalletWordsPassphrase = null;
        newWalletPassword = null;
        showWalletPassword = null;
        backupConfirmation = false;
        showBackupConfirmationError = false;
    }

    private void WalletWordsClose()
    {
        showWalletWords = null;
        backupConfirmation = false;
        showBackupConfirmationError = false;
        showWalletPasswordError = null;
        showWalletPassword = null;
        newWalletPassword = null;
    }

    private void DeleteWallet()
    {
        walletWordsModal = false;
        storage.DeleteAccountInfo(network.Name);
        _cacheStorage.DeleteUnconfirmedInfo();
        _walletStorage.DeleteWallet();
        hasWallet = _walletStorage.HasWallet();
        ClearWalletWords();
        StateHasChanged();

        NavMenuState.NotifyStateChanged();
    }

    private void GenerateNewWalletWords()
    {
        newWalletWords = _walletOperations.GenerateWalletWords();
    }

    public async Task CopyNextReceiveAddress()
    {
        var accountInfo = storage.GetAccountInfo(network.Name);
        var address = accountInfo.GetNextReceiveAddress();

        if (string.IsNullOrEmpty(address))
        {
            notificationComponent.ShowErrorMessage("New address was not created");
            return;
        }

        await _clipboardService.WriteTextAsync(address);
        notificationComponent.ShowNotificationMessage("Copied to clipboard!", 3);
    }

    private async Task RefreshFee()
    {
        // refresh fee if last refresh was 60 seconds ago

        if (_sendInfo.FeeRate == 0 || _lastFeeRefresh.AddSeconds(60) < DateTime.UtcNow)
        {
            var fees = await _walletOperations.GetFeeEstimationAsync();

            FeeEstimations.Fees = fees.ToList();

            _feeMax = FeeEstimations.Fees.Count;

            var feeItem = FeeEstimations?.Fees.MinBy(c => c.Confirmations);

            if (feeItem != null)
            {
                _sendInfo.FeeBlockCount = feeItem.Confirmations;
                _sendInfo.FeeRate = feeItem.FeeRate;
            }

            _lastFeeRefresh = DateTime.UtcNow;
        }
    }

    private async Task AskPassword()
    {
        if (string.IsNullOrEmpty(_sendInfo.SendToAddress))
        {
            notificationComponent.ShowErrorMessage("Specify a send to address");
            return;
        }

        if (_sendInfo.SendAmount == 0)
        {
            notificationComponent.ShowErrorMessage("Specify an amount");
            return;
        }

        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(BuildSend);
        }
        else
        {
            await BuildSend();
        }
    }

    private async Task BuildSend()
    {
        if (string.IsNullOrEmpty(_sendInfo.SendToAddress)) throw new ArgumentNullException();
        if (_sendInfo.SendAmount == 0) throw new ArgumentNullException();

        sendLoadSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            var accountInfo = storage.GetAccountInfo(network.Name);

            await _walletOperations.UpdateAccountInfoWithNewAddressesAsync(accountInfo);

            storage.SetAccountInfo(network.Name, accountInfo);

            await RefreshFee();

            if (FeeEstimations.Fees.Count == 0)
            {
                notificationComponent.ShowErrorMessage("Unable top calculate fee");
                return;
            }

            // by default select the highest fee
            var estimationsFee = FeeEstimations.Fees.OrderBy(fee => fee.Confirmations).ToList()[0];

            FeePosition = 1;

            _sendInfo.FeeBlockCount = estimationsFee.Confirmations;
            _sendInfo.FeeRate = estimationsFee.FeeRate;

            if (string.IsNullOrEmpty(_sendInfo.ChangeAddress))
            {
                _sendInfo.ChangeAddress = accountInfo.ChangeAddressesInfo.First(f => f.HasHistory == false).Address;
            }

            _sendInfo.SendFee = _walletOperations.CalculateTransactionFee(_sendInfo, accountInfo, estimationsFee.FeeRate);

            sendConfirmModal = true;
        }
        catch (Exception e)
        {
            passwordComponent.ClearPassword();
            sendLoadSpinner = false;
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            sendLoadSpinner = false;
        }

        StateHasChanged();
    }

    private async Task SendCoins()
    {
        if (!passwordComponent.HasPassword())
        {
            sendConfirmSpinner = false;
            sendConfirmModal = false;
            notificationComponent.ShowErrorMessage("Wallet password expired");
            return;
        }

        sendConfirmSpinner = true;
        StateHasChanged();
        await Task.Delay(10);

        try
        {
            var words = await passwordComponent.GetWalletAsync();

            var accountInfo = storage.GetAccountInfo(network.Name);
            var unconfirmedInfo = _cacheStorage.GetUnconfirmedInboundFunds();

            var res = await _walletOperations.SendAmountToAddress(words, _sendInfo);

            if (res.Success)
            {
                var pendingInbound = _walletOperations.UpdateAccountUnconfirmedInfoWithSpentTransaction(accountInfo, res.Data);
                unconfirmedInfo.AddRange(pendingInbound);
                accountBalanceInfo.UpdateAccountBalanceInfo(accountInfo, unconfirmedInfo);
                storage.SetAccountInfo(network.Name, accountInfo);
                _cacheStorage.SetUnconfirmedInboundFunds(unconfirmedInfo);

                notificationComponent.ShowNotificationMessage("Sent complete!");
            }
            else
            {
                notificationComponent.ShowErrorMessage($"Sending failed! {res.Message}");
            }

            _sendInfo = new SendInfo();
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            sendConfirmSpinner = false;
            sendConfirmModal = false;
            passwordComponent.ClearPassword();
        }
    }

    private void HandleCheckboxChange(UtxoData addressUtxoItem, string hdPath)
    {
        // Here you can handle the change
        // Note: replace AddressUtxoItem with the actual type of addressUtxoItem

        if (_sendInfo.SendUtxos.ContainsKey(addressUtxoItem.outpoint.ToString()))
        {
            _sendInfo.SendUtxos.Remove(addressUtxoItem.outpoint.ToString());
        }
        else
        {
            _sendInfo.SendUtxos.Add(addressUtxoItem.outpoint.ToString(), new UtxoDataWithPath { HdPath = hdPath, UtxoData = addressUtxoItem });
        }
    }

    private long GetRecommendedMinFee()
    {
        // Return a recommended minimum fee rate based on network conditions
        return FeeEstimations.Fees.Any()
            ? Math.Max(1, FeeEstimations.Fees.Min(f => f.FeeRate))
            : 5;
    }

    private async Task HandleFeeChanged(FeeCalculation feeCalc)
    {
        try
        {
            if (feeCalc.UseCustomFee && feeCalc.CustomFee.HasValue)
            {
                _sendInfo.FeeRate = feeCalc.CustomFee.Value;
                _sendInfo.FeeBlockCount = 0; // Custom fee doesn't have block count
            }
            else if (feeCalc.Position.HasValue && feeCalc.Position.Value <= FeeEstimations.Fees.Count)
            {
                FeePosition = feeCalc.Position.Value;
                var estimationsFee = FeeEstimations.Fees.OrderBy(fee => fee.Confirmations).ToList()[FeePosition - 1];
                _sendInfo.FeeRate = estimationsFee.FeeRate;
                _sendInfo.FeeBlockCount = estimationsFee.Confirmations;
            }

            var accountInfo = storage.GetAccountInfo(network.Name);
            _sendInfo.SendFee = _walletOperations.CalculateTransactionFee(_sendInfo, accountInfo, _sendInfo.FeeRate);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error calculating fee");
            notificationComponent.ShowErrorMessage("Error calculating fee");
        }
    }

    private void showCoinControlModal()
    {
        coinControlModal = true;
        StateHasChanged();
    }

    private async Task GetTestCoins()
    {
        if (!CanGetTestCoins())
        {
            notificationComponent.ShowNotificationMessage("you already have too much test coins!");
            return;
        }

        testCoinsSpinner = true;

        try
        {
            var receiveAddress = accountBalanceInfo.AccountInfo.GetNextReceiveAddress();

            var res = await _httpClient.GetAsync($"https://faucettmp.angor.io/api/faucet/send/{receiveAddress}");

            res.EnsureSuccessStatusCode();

            await Task.Delay(TimeSpan.FromSeconds(1));

            await RefreshBalance();
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage(e.Message, e);
        }
        finally
        {
            testCoinsSpinner = false;
        }
    }

    private bool CanGetTestCoins()
    {
        if (network.NetworkType == NetworkType.Mainnet)
        {
            return false;
        }

        if (accountBalanceInfo.TotalBalance.ToUnitBtc() > 100)
        {
            return false;
        }

        return true;
    }

    void SetActiveTab(int tab)
    {
        activeTab = tab;
    }

    bool IsExpanded(string address)
    {
        return collapseStates.ContainsKey(address) ? collapseStates[address] : false;
    }

    void ToggleCollapse(string address)
    {
        if (collapseStates.ContainsKey(address))
            collapseStates[address] = !collapseStates[address];
        else
            collapseStates[address] = true;
    }

    private async Task PasteFromClipboard()
    {
        try
        {
            var text = await ClipboardService.ReadTextAsync();
            _sendInfo.SendToAddress = text;
            StateHasChanged(); // Refresh the UI to reflect the updated value
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to read clipboard contents");
        }
    }

    private void ClearAddress()
    {
        _sendInfo.SendToAddress = string.Empty;
    }

    private void ShowExtraWord(MouseEventArgs e)
    {
        isPassphraseEnabled = !isPassphraseEnabled;
    }

    public async Task<IReadOnlyList<string>> GetBtcValuesInPreferredCurrency(params long[] btcBalances)
    {
        return await _currencyService.GetBtcValuesInPreferredCurrency(btcBalances);
    }

    public async Task<string> GetBtcValueInPreferredCurrency(long btcBalance)
    {
        var results = await GetBtcValuesInPreferredCurrency(btcBalance);
        return results.FirstOrDefault() ?? "Error fetching value";
    }


    private async Task PrecomputeFiatValues()
    {
        fiatValues.Clear();

        var btcBalance = accountBalanceInfo.TotalBalance;

        var fiatValuesList = await _currencyService.GetBtcValuesInPreferredCurrency(btcBalance);

        if (fiatValuesList == null || !fiatValuesList.Any())
        {
            Logger.LogError("Failed to fetch the fiat value for the total balance.");
            return;
        }

        fiatValues["TotalBalance"] = fiatValuesList.First(); ;

        Logger.LogInformation($"Fiat value for total balance: {fiatValuesList.First()}");
    }


    private void ShowRawTransactionJson(AddressInfo addressInfo)
    {
        rawTransactionJson = GetRawTransactionJson(addressInfo);
        showRawTransactionModal = true;
    }

    private void HandleModalVisibility(bool isVisible)
    {
        showRawTransactionModal = isVisible;
    }

    private string GetRawTransactionJson(AddressInfo addressInfo)
    {
        var options = new JsonSerializerOptions { WriteIndented = true };
        return JsonSerializer.Serialize(addressInfo, options);
    }

    private async Task CopyStringToClipboard(string msg)
    {
        await _clipboardService.WriteTextAsync(msg);
        notificationComponent.ShowNotificationMessage("Copied to clipboard!", 3);
        StateHasChanged();
    }

    private async Task PrepareTransactionJson()
    {
        string feeRateDescription = _sendInfo.FeeBlockCount > 0
            ? $"{_sendInfo.FeeRate} sats per byte for {_sendInfo.FeeBlockCount} block confirmations"
            : $"{_sendInfo.FeeRate} sats per byte";

        var transactionDetails = new
        {
            Amount = _sendInfo.SendAmount,
            ToAddress = _sendInfo.SendToAddress,
            Fee = _sendInfo.SendFee,
            FeeRate = feeRateDescription,
            ChangeAddress = _sendInfo.ChangeAddress,
            Inputs = _sendInfo.SendUtxos.Select(u => new
            {
                Address = u.Value.UtxoData.address,
                Amount = Money.Satoshis(u.Value.UtxoData.value).ToUnit(MoneyUnit.BTC),
                Outpoint = u.Key,
                CoinTicker = network.CoinTicker
            })
        };

        transactionJson = JsonSerializer.Serialize(transactionDetails, new JsonSerializerOptions { WriteIndented = true });
    }



    private async Task ShowTransactionJson()
    {
        await PrepareTransactionJson();
        showTransactionJsonModal = true;
    }

    private void HandleTransactionJsonModalVisibility(bool isVisible)
    {
        showTransactionJsonModal = isVisible;
    }

    private void PrepareFullVerification()
    {
        if (string.IsNullOrEmpty(newWalletWords)) return;

        var words = newWalletWords.Trim().Split(' ').ToList();
        if (words.Count != 12)
        {
            notificationComponent.ShowErrorMessage("Recovery phrase should contain 12 words.");
            return;
        }

        selectedWordsToVerify.Clear();
        userVerificationInputs.Clear();
        shuffledWordIndices.Clear();
        verificationPassed = false;

        var random = new Random();
        var originalIndices = Enumerable.Range(0, words.Count).ToList();
        var shuffled = originalIndices.OrderBy(x => random.Next()).ToList();

        for (int i = 0; i < words.Count; i++)
        {
            int originalIndex = i;
            int shuffledDisplayOrder = shuffled.IndexOf(originalIndex);

            selectedWordsToVerify.Add((originalIndex + 1, words[originalIndex]));
            userVerificationInputs[originalIndex + 1] = string.Empty;
            shuffledWordIndices.Add((originalIndex, shuffledDisplayOrder));
        }

        shuffledWordIndices = shuffledWordIndices.OrderBy(item => item.shuffledIndex).ToList();
    }

    private bool VerifyWords()
    {
        if (string.IsNullOrEmpty(newWalletWords)) return false;
        var originalWords = newWalletWords.Trim().Split(' ').ToList();

        if (userVerificationInputs.Count != 12) return false;

        for (int i = 1; i <= 12; i++)
        {
            if (!userVerificationInputs.ContainsKey(i) ||
                string.IsNullOrWhiteSpace(userVerificationInputs[i]) ||
                userVerificationInputs[i].Trim().ToLower() != originalWords[i - 1].ToLower())
            {
                return false;
            }
        }

        return true;
    }

    private async Task CopyWalletWords()
    {
        if (!string.IsNullOrEmpty(newWalletWords))
        {
            await _clipboardService.WriteTextAsync(newWalletWords);
            notificationComponent.ShowNotificationMessage("Words copied to clipboard!", 3);
        }
    }

    private void ValidateWordInput()
    {
        if (userVerificationInputs.Count == 12 &&
            userVerificationInputs.All(kvp => !string.IsNullOrWhiteSpace(kvp.Value)))
        {
            verificationPassed = VerifyWords();
            showVerificationError = !verificationPassed;
        }
        else
        {
            verificationPassed = false;
            showVerificationError = false;
        }
    }

    private void ResetWalletCreationState()
    {
        // Reset wallet form data
        newWalletWords = null;
        newWalletWordsPassphrase = null;
        newWalletPassword = null;
        passphraseInput = null;

        // Reset UI state
        currentStep = 1;
        isPassphraseEnabled = false;
        backupConfirmation = false;
        showBackupConfirmationError = false;

        // Reset verification state
        selectedWordsToVerify.Clear();
        userVerificationInputs.Clear();
        shuffledWordIndices.Clear();
        verificationPassed = false;
        showVerificationError = false;
    }

    private void SkipVerification()
    {
        verificationPassed = true;
        showVerificationError = false;
        NextStep();
    }

    protected override void OnInitialized()
    {
        NavMenuState.SetActivePage("wallet");
        base.OnInitialized();
    }

    private void HandleWordInput(int wordIndex, ChangeEventArgs e)
    {
        string input = e.Value?.ToString() ?? string.Empty;
        userVerificationInputs[wordIndex] = input;
        showSuggestions[wordIndex] = !string.IsNullOrWhiteSpace(input);
        ValidateWordInput();
        ValidateWordInstant(wordIndex, input);
    }

    private void ValidateWordInstant(int wordIndex, string input)
    {
        var wordlist = NBitcoin.Wordlist.English;
        var words = wordlist.GetWords();
        if (!string.IsNullOrWhiteSpace(input) && !words.Contains(input.ToLowerInvariant()))
            invalidWordIndices[wordIndex] = true;
        else
            invalidWordIndices[wordIndex] = false;
    }

    private void ShowDropdown(int wordIndex)
    {
        showSuggestions[wordIndex] = true;
    }

    private void CloseDropdown(int wordIndex)
    {
        showSuggestions[wordIndex] = false;
    }

    private void ShowSuggestionsIfNeeded(int wordIndex)
    {
        if (!string.IsNullOrWhiteSpace(userVerificationInputs[wordIndex]))
        {
            showSuggestions[wordIndex] = true;
            StateHasChanged();
        }
    }

    private void SelectSuggestion(int wordIndex, string suggestion)
    {
        userVerificationInputs[wordIndex] = suggestion;
        showSuggestions[wordIndex] = false;
        ValidateWordInput();
        StateHasChanged();
    }

    private IEnumerable<string> GetFilteredWordSuggestions(string input)
    {
        var wordlist = NBitcoin.Wordlist.English;
        var words = wordlist.GetWords();
        return words.Where(word => word.StartsWith(input, StringComparison.OrdinalIgnoreCase));
    }

    private void OnImportWordsInput(ChangeEventArgs e)
    {
        newWalletWords = e.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }
}
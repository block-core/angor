@page "/messages"
@page "/messages/{ProjectId}"
@page "/messages/{ProjectId}/{ChatMode}"
@page "/messages/{ProjectId}/{ChatMode}/{PartnerPubKey}"
@using Angor.Client.Storage
@using Angor.Shared.Models
@using Angor.Shared.Services
@using Angor.Client.Shared
@using Blockcore.NBitcoin.DataEncoders
@using System.Security.Cryptography
@using Angor.Client.Models
@using Angor.Shared.Utilities
@using Blockcore.NBitcoin
@using Angor.Shared
@using Nostr.Client.Messages
@using System.Collections.ObjectModel
@using System.Timers
@using System.Reactive.Linq
@using Angor.Client.Services

@inject IClientStorage storage
@inject IWalletStorage _walletStorage
@inject IDerivationOperations _derivationOperations
@inject NavigationManager NavigationManager
@inject IIndexerService _IndexerService
@inject IMessageService _messageService
@inject INostrCommunicationFactory _nostrCommunicationFactory
@inject ISignService _SignService
@inject ISerializer serializer
@inject IEncryptionService _encryptionService
@inject IJSRuntime JS
@inject NavMenuState NavMenuState
@inject NostrConversionHelper NostrHelper
@inject INetworkService _NetworkService
@implements IDisposable

@inherits BaseComponent

<NotificationComponent @ref="notificationComponent" />
<PasswordComponent @ref="passwordComponent" />

@if (!hasWallet)
{
    NavigationManager.NavigateTo($"/wallet");
    return;
}

<div class="header-container slide-in">
    <div class="card card-body">
        <div class="header-content">
            <div class="header-title animate-fade-in">
                <span class="header-icon-wrapper">
                    <Icon IconName="chat" Width="32" Height="32" />
                </span>
                <h5 class="header-text">Messages</h5>
            </div>
            <div class="header-actions">
                <button class="btn btn-border-success"
                        @onclick="RefreshProjects"
                        disabled="@refreshSpinner"
                        title="Refresh">
                    @if (refreshSpinner)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <Icon IconName="refresh" Height="24" Width="24" />
                        <span class="button-text ms-2">Refresh</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-0 g-4">
     <div class="col-lg-4 col-12 mb-3 mb-lg-0">
        <!-- Contact/Project List -->
        <div class="card card-body mb-4">
            @if (showingInvestorsInSidebar && currentFounderProject != null)
            {
                <!-- Investors List in Sidebar -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-sm btn-border" @onclick="BackToProjects">
                        <Icon IconName="arrow-left" Height="16" Width="16" />
                        <span class="ms-1">Back</span>
                    </button>
                    <h6 class="mb-0">Investors</h6>
                </div>

                @if (loadingInvestors)
                {
                    <div class="d-flex justify-content-center my-4">
                        <div class="loader"></div>
                    </div>
                }
                else if (!projectInvestors.Any())
                {
                    <div class="info-alert my-4">
                        <Icon IconName="info" Class="alert-icon" Width="24" Height="24" />
                        <p class="text-warning">
                            This project doesn't have any investors yet.
                        </p>
                    </div>
                }
                else
                {
                    <div class="investors-list mt-3">
                        @foreach (var investor in projectInvestors)
                        {
                            <div class="contact-item" @onclick="() => StartChatWithInvestor(investor)">
                                <div class="contact-avatar">
                                    <div class="avatar-placeholder">
                                        <Icon IconName="user" Height="24" Width="24" />
                                    </div>
                                </div>
                                <div class="contact-info">
                                    <div class="contact-name">@GetTruncatedNpub(investor.InvestorNPub)</div>
                                    <div class="contact-preview">@investor.TotalAmount.ToUnitBtc() @network.CoinTicker</div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="tab-container">
                    <div class="tabs-wrapper">
                        <div class="tab-item @(activeTab == 1 ? "active" : "")" @onclick="() => SetActiveTab(1)" data-cy="investments-tab">
                            <div class="tab-content">
                                <div class="tab-icon @(activeTab == 1 ? "heartbeat" : "")" aria-hidden="true">
                                    <Icon IconName="portfolio" Height="20" Width="20" />
                                </div>
                                <span class="tab-label">Investments</span>
                            </div>
                        </div>

                        <div class="tab-item @(activeTab == 2 ? "active" : "")" @onclick="() => SetActiveTab(2)" data-cy="founder-tab">
                            <div class="tab-content">
                                <div class="tab-icon @(activeTab == 2 ? "heartbeat" : "")" aria-hidden="true">
                                    <Icon IconName="founder" Height="20" Width="20" />
                                </div>
                                <span class="tab-label">Projects</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-group mt-3 mb-3">
                    <input type="text" class="form-control" placeholder="Search contacts..." @bind="searchQuery" @oninput="SearchContacts">
                    <button class="btn btn-border" type="button">
                        <Icon IconName="search" />
                    </button>
                </div>

                <div class="contacts-list mt-3">
                    @if (activeTab == 1)
                    {
                        <!-- Investments List -->
                        @if (!filteredInvestorProjects.Any())
                        {
                            <div class="text-center p-3">
                                <p class="text-muted">No investments found.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var project in filteredInvestorProjects)
                            {
                                <div class="contact-item @(currentChat?.ProjectId == project.ProjectInfo.ProjectIdentifier && !isFounderChat ? "active" : "")" @onclick="() => SelectInvestorChat(project)">
                                    <div class="contact-avatar">
                                        @if (!string.IsNullOrEmpty(project.Metadata?.Picture))
                                        {
                                            <img src="@project.Metadata.Picture" alt="Project" onerror="this.onerror=null; this.src='/assets/img/no-image.jpg';">
                                        }
                                        else
                                        {
                                            <div class="avatar-placeholder">
                                                <Icon IconName="project" Height="24" Width="24" />
                                            </div>
                                        }
                                    </div>
                                    <div class="contact-info">
                                        <div class="contact-name">@(project.Metadata?.Name ?? "Project " + project.ProjectInfo.ProjectIdentifier.Substring(0, 8))</div>
                                        <div class="contact-preview">@project.ProjectInfo.ProjectIdentifier.Substring(0, 8)...</div>
                                    </div>
                                    @if (unreadMessages.ContainsKey($"investor-{project.ProjectInfo.ProjectIdentifier}") && unreadMessages[$"investor-{project.ProjectInfo.ProjectIdentifier}"] > 0)
                                    {
                                        <div class="message-badge">@unreadMessages[$"investor-{project.ProjectInfo.ProjectIdentifier}"]</div>
                                    }
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <!-- Founder Projects List -->
                        @if (!filteredFounderProjects.Any())
                        {
                            <div class="text-center p-3">
                                <p class="text-muted">No projects found.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var project in filteredFounderProjects)
                            {
                                <div class="contact-item @(currentChat?.ProjectId == project.ProjectInfo.ProjectIdentifier && isFounderChat ? "active" : "")" @onclick="() => SelectFounderChat(project)">
                                    <div class="contact-avatar">
                                        @if (!string.IsNullOrEmpty(project.Metadata?.Picture))
                                        {
                                            <img src="@project.Metadata.Picture" alt="Project" onerror="this.onerror=null; this.src='/assets/img/no-image.jpg';">
                                        }
                                        else
                                        {
                                            <div class="avatar-placeholder">
                                                <Icon IconName="founder" Height="24" Width="24" />
                                            </div>
                                        }
                                    </div>
                                    <div class="contact-info">
                                        <div class="contact-name">@(project.Metadata?.Name ?? "Project " + project.ProjectInfo.ProjectIdentifier.Substring(0, 8))</div>
                                        <div class="contact-preview">@(projectInvestorCounts.ContainsKey(project.ProjectInfo.ProjectIdentifier) ? projectInvestorCounts[project.ProjectInfo.ProjectIdentifier] : 0) investors</div>
                                    </div>
                                    @if (unreadMessages.ContainsKey($"founder-{project.ProjectInfo.ProjectIdentifier}") && unreadMessages[$"founder-{project.ProjectInfo.ProjectIdentifier}"] > 0)
                                    {
                                        <div class="message-badge">@unreadMessages[$"founder-{project.ProjectInfo.ProjectIdentifier}"]</div>
                                    }
                                </div>
                            }
                        }
                    }
                </div>
            }
        </div>
    </div>

    <div class="col-lg-8 col-12">
        <!-- Chat Interface -->
        <div class="card card-body chat-container">
            @if (currentChat == null)
            {
                <div class="empty-chat-state">
                    <div class="empty-chat-icon">
                        <Icon IconName="message" Width="64" Height="64" />
                    </div>
                    <h5>Select a contact to start messaging</h5>
                    <p class="text-muted">Choose a project or investment to begin your conversation</p>
                </div>
            }
            else
            {
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <div class="chat-avatar me-3">
                            @if (!string.IsNullOrEmpty(currentChat.Picture))
                            {
                                <img src="@currentChat.Picture" alt="Chat" onerror="this.onerror=null; this.src='/assets/img/no-image.jpg';">
                            }
                            else
                            {
                                <div class="avatar-placeholder">
                                    <Icon IconName="@(isFounderChat ? "founder" : "project")" Height="24" Width="24" />
                                </div>
                            }
                        </div>
                        <div>
                            <h5 class="mb-0">@currentChat.Name</h5>
                            <small class="text-muted">@currentChat.Description</small>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-border" @onclick="ShowIdentitiesModal">
                            <Icon IconName="key" Height="20" Width="20" />
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" @ref="messagesContainerRef">
                    @if (isLoadingMessages)
                    {
                        <div class="loading-messages">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading messages...</p>
                        </div>
                    }
                    else if (!chatMessages.Any())
                    {
                        <div class="empty-messages">
                            <Icon IconName="message" Width="32" Height="32" />
                            <p>No messages yet. Start a conversation!</p>
                        </div>
                    }
                    else
                    {
                        <div class="messages-list">
                            @foreach (var message in chatMessages)
                            {
                                <div class="message-item @(message.IsFromCurrentUser ? "outgoing" : "incoming")">
                                    <div class="message-bubble">
                                        <div class="message-content">@message.Content</div>
                                        <div class="message-timestamp">@message.Timestamp.ToLocalTime().ToString("HH:mm")</div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Chat Input -->
                <div class="chat-input">
                    @* @if (showEmojiPicker)
                    {
                        <div class="emoji-picker card card-body mb-2">
                            <div class="d-flex flex-wrap">
                                @foreach (var emoji in commonEmojis)
                                {
                                    <button class="btn btn-sm" @onclick="() => InsertEmoji(emoji)">
                                        <span style="font-size: 1.2rem;">@emoji</span>
                                    </button>
                                }
                            </div>
                        </div>
                    } *@
                    
                    <div class="input-group">
                        @* <button class="btn btn-border" title="Add emoji" @onclick="ToggleEmojiPicker">
                            <span role="img" aria-label="emoji">ðŸ˜Š</span>
                        </button> *@
                        <textarea class="form-control"
                                  placeholder="Type a message..."
                                  @bind="newMessage"
                                  @onkeydown="@(async e => { if((e.Key is "Enter" or "NumpadEnter") && !e.ShiftKey) { await SendMessageAndCheckPassword(); } })"
                                  disabled="@isSendingMessage" />
                        <button class="btn btn-border-success"
                                @onclick="SendMessageAndCheckPassword"
                                disabled="@isSendingMessage">
                            @if (isSendingMessage)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            }
                            else
                            {
                                <Icon IconName="send" Height="20" Width="20" />
                            }
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Identities Modal -->
@if (showIdentitiesModal)
{
    <div class="modal-wrapper">
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modern-modal animate-fade-in">
                    <div class="modal-header border-0 pb-0">
                        <div class="d-flex align-items-center">
                            <Icon IconName="key" Height="32" Width="32" class="me-2" />
                            <h5 class="modal-title">Nostr Identities</h5>
                        </div>
                        <button class="btn-close-custom" @onclick="() => showIdentitiesModal = false">
                            <Icon IconName="close-circle" Height="24" Width="24" />
                        </button>
                    </div>

                    <div class="modal-body py-4">
                        <div class="d-flex flex-column gap-3">
                            <div class="info-card p-3 mt-2 animate-fade-in">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="info-label mb-2">Your NPUB:</div>
                                    <button class="btn btn-sm btn-border" @onclick="() => CopyToClipboard(currentUserNpub)">
                                        <Icon IconName="copy" Width="16" Height="16" />
                                    </button>
                                </div>
                                <div class="info-value text-break word-wrap">
                                    @currentUserNpub
                                </div>
                            </div>

                            <div class="info-card p-3 mt-2 animate-fade-in">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="info-label mb-2">Partner NPUB:</div>
                                    <button class="btn btn-sm btn-border" @onclick="() => CopyToClipboard(partnerNpub)">
                                        <Icon IconName="copy" Width="16" Height="16" />
                                    </button>
                                </div>
                                <div class="info-value text-break word-wrap">
                                    @partnerNpub
                                </div>
                            </div>

                            <button type="button" class="btn btn-border-warning w-100" @onclick="ShowNsecAndCheckPassword">
                                <Icon IconName="key" Width="20" Height="20" class="me-2" />
                                <span>Show NSEC</span>
                            </button>

                            @if (showNsec)
                            {
                                <div class="info-card p-3 mt-2 animate-fade-in">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="info-label mb-2">NSEC (Private Key):</div>
                                        <button class="btn btn-sm btn-border" @onclick="() => CopyToClipboard(nsecValue)">
                                            <Icon IconName="copy" Width="16" Height="16" />
                                        </button>
                                    </div>
                                    <div class="info-value text-break word-wrap">
                                        @nsecValue
                                    </div>
                                    <div class="mt-2 alert alert-warning">
                                        <strong>Warning:</strong> Never share your private key with anyone.
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-border-warning" @onclick="() => showIdentitiesModal = false">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Investors List Modal -->
@if (showInvestorsModal)
{
    <div class="modal-wrapper">
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content modern-modal animate-fade-in">
                    <div class="modal-header border-0 pb-0">
                        <div class="d-flex align-items-center">
                            <Icon IconName="users" Height="32" Width="32" class="me-2" />
                            <h5 class="modal-title">Project Investors</h5>
                        </div>
                        <button class="btn-close-custom" @onclick="() => showInvestorsModal = false">
                            <Icon IconName="close-circle" Height="24" Width="24" />
                        </button>
                    </div>

                    <div class="modal-body py-4">
                        @if (loadingInvestors)
                        {
                            <div class="d-flex justify-content-center my-4">
                                <div class="loader"></div>
                            </div>
                        }
                        else if (!projectInvestors.Any())
                        {
                            <div class="info-alert my-4">
                                <Icon IconName="info" Class="alert-icon" Width="24" Height="24" />
                                <p class="text-warning">
                                    This project doesn't have any investors yet.
                                </p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive form-control">
                                <table class="table align-items-center mb-0">
                                    <thead>
                                        <tr>
                                            <th class="text-uppercase text-xxs font-weight-bolder opacity-7">Investor</th>
                                            <th class="text-uppercase text-xxs font-weight-bolder opacity-7">Amount</th>
                                            <th class="text-uppercase text-xxs font-weight-bolder opacity-7">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var investor in projectInvestors)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="d-flex flex-column">
                                                        <h6 class="mb-0 text-sm">@GetTruncatedNpub(investor.InvestorPublicKey)</h6>
                                                        <p class="text-xs text-secondary mb-0">Investor</p>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-gradient-success">@investor.TotalAmount.ToUnitBtc() @network.CoinTicker</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-border-success" @onclick="() => StartChatWithInvestor(investor)">
                                                        <Icon IconName="chat" Height="16" Width="16" class="me-1" />
                                                        Chat
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>

                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-border-warning" @onclick="() => showInvestorsModal = false">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Core components
    private NotificationComponent notificationComponent;
    private PasswordComponent passwordComponent;
    private ElementReference messagesContainerRef;
    private Timer refreshTimer;

    // UI state
    private int activeTab = 1;
    private bool refreshSpinner = false;
    private bool isLoadingMessages = false;
    private bool isSendingMessage = false;
    private string searchQuery = "";
    private string newMessage = "";
    private bool showingInvestorsInSidebar = false;

    // Projects
    private List<InvestorProject> investorProjects = new();
    private List<InvestorProject> filteredInvestorProjects = new();
    private List<FounderProject> founderProjects = new();
    private List<FounderProject> filteredFounderProjects = new();
    private Dictionary<string, int> projectInvestorCounts = new();
    private Dictionary<string, int> unreadMessages = new();

    // Chat properties
    private bool showIdentitiesModal = false;
    private bool isFounderChat = false;
    private string currentUserNpub = "";
    private string partnerNpub = "";
    private string nsecValue = "";
    private bool showNsec = false;
    private string currentUserPrivateKeyHex = "";
    private ChatSession currentChat;
    private List<ChatMessage> chatMessages = new();

    // Investors modal
    private bool showInvestorsModal = false;
    private bool loadingInvestors = false;
    private List<InvestmentInfo> projectInvestors = new();
    private FounderProject currentFounderProject;

    // Navigation parameters
    [Parameter]
    public string ProjectId { get; set; }

    [Parameter]
    public string PartnerPubKey { get; set; }

    [Parameter]
    public string ChatMode { get; set; }

    // Chat Models
    public class ChatSession
    {
        public string ProjectId { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public string Picture { get; set; }
        public string UserNpub { get; set; }
        public string PartnerNpub { get; set; }
        public string UserPrivateKeyHex { get; set; }
        public string PartnerPubKeyHex { get; set; } 
    }

    public class ChatMessage
    {
        public string Id { get; set; }
        public string Content { get; set; }
        public string SenderPubkey { get; set; }
        public DateTime Timestamp { get; set; }
        public bool IsFromCurrentUser { get; set; }
    }

    public class InvestmentInfo
    {
        public string InvestorPublicKey { get; set; }
        public string InvestorNPub { get; set; }
        public long TotalAmount { get; set; }
        public string TransactionId { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Set active menu
        NavMenuState.SetActivePage("messages");

        if (hasWallet)
        {
            try
            {
                await LoadProjects();

                // Check if we have chat parameters
                if (!string.IsNullOrEmpty(ProjectId))
                {
                    await InitializeChat();
                }
            }
            catch (Exception ex)
            {
                notificationComponent?.ShowErrorMessage("An error occurred during initialization", ex);
            }

            // Initialize timer to periodically refresh messages
            refreshTimer = new Timer(15000); // 15 seconds
            refreshTimer.Elapsed += async (sender, e) => await RefreshCurrentChat();
            refreshTimer.AutoReset = true;
            refreshTimer.Enabled = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Subscribe to message service events
            _messageService.OnChange += HandleMessageServiceChange;
        }

        // Scroll to bottom of messages when new messages arrive
        if (messagesContainerRef.Context != null && chatMessages.Any())
        {
            await JS.InvokeVoidAsync("scrollToBottom", messagesContainerRef);
        }
    }

    private async Task LoadProjects()
    {
        refreshSpinner = true;
        StateHasChanged();

        try
        {
            // Load investor projects
            investorProjects = storage?.GetInvestmentProjects()
                .Where(p => !string.IsNullOrEmpty(p.TransactionId))
                .ToList() ?? new List<InvestorProject>();

            filteredInvestorProjects = investorProjects.ToList();

            // Load founder projects
            founderProjects = storage?.GetFounderProjects()
                .Where(p => !string.IsNullOrEmpty(p.CreationTransactionId))
                .ToList() ?? new List<FounderProject>();

            filteredFounderProjects = founderProjects.ToList();

            // Get investor counts for founder projects
            foreach (var project in founderProjects)
            {
                var count = await GetInvestorCount(project.ProjectInfo.ProjectIdentifier);
                projectInvestorCounts[project.ProjectInfo.ProjectIdentifier] = count;
            }
        }
        catch (Exception ex)
        {
            notificationComponent?.ShowErrorMessage("Failed to load projects", ex);
        }
        finally
        {
            refreshSpinner = false;
            StateHasChanged();
        }
    }

    private async Task<int> GetInvestorCount(string projectIdentifier)
    {
        try
        {
            var investments = await _IndexerService.GetInvestmentsAsync(projectIdentifier);
            return investments?.Count ?? 0;
        }
        catch
        {
            return 0;
        }
    }

    private void SetActiveTab(int tabNumber)
    {
        activeTab = tabNumber;
    }

    private void SearchContacts(ChangeEventArgs e)
    {
        var query = e.Value?.ToString().ToLower() ?? "";
        searchQuery = query;

        if (string.IsNullOrWhiteSpace(query))
        {
            filteredInvestorProjects = investorProjects.ToList();
            filteredFounderProjects = founderProjects.ToList();
        }
        else
        {
            filteredInvestorProjects = investorProjects
                .Where(p => p.Metadata?.Name?.ToLower().Contains(query) == true ||
                           p.ProjectInfo.ProjectIdentifier.ToLower().Contains(query))
                .ToList();

            filteredFounderProjects = founderProjects
                .Where(p => p.Metadata?.Name?.ToLower().Contains(query) == true ||
                            p.ProjectInfo.ProjectIdentifier.ToLower().Contains(query))
                .ToList();
        }

        StateHasChanged();
    }

    private async Task RefreshProjects()
    {
        await LoadProjects();
    }

    private async Task SelectInvestorChat(InvestorProject project)
    {
        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(async () =>
            {
                await InitializeInvestorChat(project);
                // Update URL without adding to browser history
                UpdateBrowserUrl(project.ProjectInfo.ProjectIdentifier, "investor", null);
            });
        }
        else
        {
            await InitializeInvestorChat(project);
            // Update URL without adding to browser history
            UpdateBrowserUrl(project.ProjectInfo.ProjectIdentifier, "investor", null);
        }
    }

    private async Task InitializeInvestorChat(InvestorProject project)
    {
        try
        {
            isLoadingMessages = true;
            isFounderChat = false;
            chatMessages.Clear();
            StateHasChanged();

            // Get necessary keys
            var words = await passwordComponent.GetWalletAsync();
            var investorNostrPrivateKey = _derivationOperations.DeriveProjectNostrPrivateKey(words, project.ProjectInfo.FounderKey);
            var nostrPrivateKeyHex = Encoders.Hex.EncodeData(investorNostrPrivateKey.ToBytes());
            
            // Set current user private key
            currentUserPrivateKeyHex = nostrPrivateKeyHex;

            // Get Nostr identities
            string investorNpub = NostrHelper.ConvertHexToNpub(project.InvestorNPub) ?? project.InvestorNPub;
            string founderNpub = NostrHelper.ConvertHexToNpub(project.ProjectInfo.NostrPubKey) ?? project.ProjectInfo.NostrPubKey;

            // Get partner's public key in hex format
            string partnerPubKeyHex = project.ProjectInfo.NostrPubKey;
            if (partnerPubKeyHex.StartsWith("npub"))
            {
                partnerPubKeyHex = NostrHelper.ConvertBech32ToHex(partnerPubKeyHex);
            }

            // Set current identities
            currentUserNpub = investorNpub;
            partnerNpub = founderNpub;

            // Create chat session
            currentChat = new ChatSession
            {
                ProjectId = project.ProjectInfo.ProjectIdentifier,
                Name = project.Metadata?.Name ?? $"Project {project.ProjectInfo.ProjectIdentifier.Substring(0, 8)}",
                Description = "Chat with project founder",
                Picture = project.Metadata?.Picture,
                UserNpub = investorNpub,
                PartnerNpub = founderNpub,
                UserPrivateKeyHex = nostrPrivateKeyHex,
                PartnerPubKeyHex = partnerPubKeyHex
            };

            // Reset unread counter
            string chatKey = $"investor-{project.ProjectInfo.ProjectIdentifier}";
            if (unreadMessages.ContainsKey(chatKey))
            {
                unreadMessages[chatKey] = 0;
            }

            // Initialize the message service with our keys
            await _messageService.InitializeAsync(
                currentUserPrivateKeyHex,
                currentUserNpub,
                partnerPubKeyHex
            );

            // Load messages
            await LoadChatMessages();
        }
        catch (Exception ex)
        {
            notificationComponent.ShowErrorMessage("Failed to initialize chat", ex);
        }
        finally
        {
            isLoadingMessages = false;
            StateHasChanged();
        }
    }

    private async Task SelectFounderChat(FounderProject project)
    {
        currentFounderProject = project;
        showingInvestorsInSidebar = true;
        loadingInvestors = true;

        // Update URL
        UpdateBrowserUrl(project.ProjectInfo.ProjectIdentifier, "founder", null);
        StateHasChanged();

        try
        {
            var investments = await _IndexerService.GetInvestmentsAsync(project.ProjectInfo.ProjectIdentifier);

            // Convert to our local model
            projectInvestors = investments.Select(inv => new InvestmentInfo
            {
                InvestorPublicKey = inv.InvestorPublicKey,
                InvestorNPub = inv.InvestorPublicKey,
                TotalAmount = inv.TotalAmount,
                TransactionId = inv.TransactionId
            }).ToList();

            if (projectInvestors.Count == 0)
            {
                notificationComponent.ShowNotificationMessage("This project has no investors yet.");
            }
        }
        catch (Exception ex)
        {
            notificationComponent.ShowErrorMessage("Failed to load investors", ex);
            projectInvestors = new List<InvestmentInfo>();
        }
        finally
        {
            loadingInvestors = false;
            StateHasChanged();
        }
    }

    private async Task ViewInvestors(FounderProject project, bool forChat = false)
    {
        if (forChat)
        {
            await SelectFounderChat(project);
            return;
        }

        // Original implementation for modal display
        currentFounderProject = project;
        showInvestorsModal = true;
        loadingInvestors = true;
        StateHasChanged();

        try
        {
            var investments = await _IndexerService.GetInvestmentsAsync(project.ProjectInfo.ProjectIdentifier);

            projectInvestors = investments.Select(inv => new InvestmentInfo
            {
                InvestorPublicKey = inv.InvestorPublicKey,
                InvestorNPub = inv.InvestorPublicKey,
                TotalAmount = inv.TotalAmount,
                TransactionId = inv.TransactionId
            }).ToList();

            if (!forChat && projectInvestors.Count == 0)
            {
                notificationComponent.ShowNotificationMessage("This project has no investors yet.");
            }
        }
        catch (Exception ex)
        {
            notificationComponent.ShowErrorMessage("Failed to load investors", ex);
            projectInvestors = new List<InvestmentInfo>();
        }
        finally
        {
            loadingInvestors = false;
            StateHasChanged();
        }
    }

    private async Task StartChatWithInvestor(InvestmentInfo investor)
    {
        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(async () =>
            {
                await InitializeFounderChat(investor);
                UpdateBrowserUrl(currentFounderProject.ProjectInfo.ProjectIdentifier, "founder", investor.InvestorPublicKey);
            });
        }
        else
        {
            await InitializeFounderChat(investor);
            UpdateBrowserUrl(currentFounderProject.ProjectInfo.ProjectIdentifier, "founder", investor.InvestorPublicKey);
        }
    }

    private async Task InitializeFounderChat(InvestmentInfo investor)
    {
        try
        {
            isLoadingMessages = true;
            isFounderChat = true;
            chatMessages.Clear();
            showInvestorsModal = false;
            StateHasChanged();

            if (currentFounderProject == null) return;

            // Get necessary keys
            var words = await passwordComponent.GetWalletAsync();
            var founderNostrPrivateKey = _derivationOperations.DeriveProjectNostrPrivateKey(words, currentFounderProject.ProjectInfo.FounderKey);
            var nostrPrivateKeyHex = Encoders.Hex.EncodeData(founderNostrPrivateKey.ToBytes());
            
            // Set current user private key
            currentUserPrivateKeyHex = nostrPrivateKeyHex;

            // Get Nostr identities
            string founderNpub = NostrHelper.ConvertHexToNpub(currentFounderProject.ProjectInfo.NostrPubKey) ?? 
                currentFounderProject.ProjectInfo.NostrPubKey;
            string investorNpub = NostrHelper.ConvertHexToNpub(investor.InvestorPublicKey) ?? investor.InvestorPublicKey;

            // Get partner's public key in hex format
            string partnerPubKeyHex = investor.InvestorPublicKey;
            if (investorNpub.StartsWith("npub") && partnerPubKeyHex.StartsWith("npub"))
            {
                partnerPubKeyHex = NostrHelper.ConvertBech32ToHex(investorNpub);
            }

            // Set current identities
            currentUserNpub = founderNpub;
            partnerNpub = investorNpub;

            // Create chat session
            currentChat = new ChatSession
            {
                ProjectId = currentFounderProject.ProjectInfo.ProjectIdentifier,
                Name = $"Investor {GetTruncatedNpub(investor.InvestorPublicKey)}",
                Description = $"Investment: {investor.TotalAmount.ToUnitBtc()} {network.CoinTicker}",
                Picture = null,
                UserNpub = founderNpub,
                PartnerNpub = investorNpub,
                UserPrivateKeyHex = nostrPrivateKeyHex,
                PartnerPubKeyHex = partnerPubKeyHex
            };

            // Reset unread counter
            string chatKey = $"founder-{currentFounderProject.ProjectInfo.ProjectIdentifier}";
            if (unreadMessages.ContainsKey(chatKey))
            {
                unreadMessages[chatKey] = 0;
            }

            // Initialize the message service with our keys
            await _messageService.InitializeAsync(
                currentUserPrivateKeyHex,
                currentUserNpub,
                partnerPubKeyHex
            );

            // Load messages
            await LoadChatMessages();
        }
        catch (Exception ex)
        {
            notificationComponent.ShowErrorMessage("Failed to initialize chat", ex);
        }
        finally
        {
            isLoadingMessages = false;
            StateHasChanged();
        }
    }

    private async Task LoadChatMessages()
    {
        if (currentChat == null) return;

        chatMessages.Clear();
        isLoadingMessages = true;
        StateHasChanged();

        try
        {
            // Load messages using the service
            await _messageService.LoadMessagesAsync();
            
            // Update UI with messages from service
            UpdateChatMessagesFromService();
        }
        catch (Exception ex)
        {
            notificationComponent.ShowErrorMessage("Failed to load chat messages", ex);
        }
        finally
        {
            isLoadingMessages = false;
            StateHasChanged();
        }
    }
    
    private void UpdateChatMessagesFromService()
    {
        // Get messages from the service and convert to our UI model
        chatMessages = _messageService.DirectMessages
            .Select(dm => new ChatMessage
            {
                Id = dm.Id,
                Content = dm.Content,
                SenderPubkey = dm.SenderPubkey,
                Timestamp = dm.Timestamp,
                IsFromCurrentUser = dm.IsFromCurrentUser
            })
            .OrderBy(m => m.Timestamp)
            .ToList();
    }

    private void HandleMessageServiceChange()
    {
        if (currentChat == null) return;

        // Update UI with latest messages
        UpdateChatMessagesFromService();

        // Update unread message counter
        string chatKey = isFounderChat ? 
            $"founder-{currentChat.ProjectId}" : 
            $"investor-{currentChat.ProjectId}";

        // Count unread messages (messages not from current user)
        int unreadCount = chatMessages.Count(m => !m.IsFromCurrentUser);
        
        if (unreadCount > 0)
        {
            unreadMessages[chatKey] = unreadCount;
        }

        StateHasChanged();
    }

    private async Task RefreshCurrentChat()
    {
        if (currentChat != null)
        {
            // Only refresh if we aren't already refreshing
            if (!_messageService.IsRefreshing)
            {
                await InvokeAsync(async () =>
                {
                    await _messageService.RefreshMessagesAsync();
                    StateHasChanged();
                });
            }
        }
    }

    private async Task SendMessageAndCheckPassword()
    {
        if (string.IsNullOrWhiteSpace(newMessage)) return;

        if (!passwordComponent.HasPassword())
        {
            passwordComponent.ShowPassword(SendMessage);
        }
        else
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (currentChat == null || string.IsNullOrWhiteSpace(newMessage)) return;

        isSendingMessage = true;
        StateHasChanged();

        try
        {
            // Send message using the service
            await _messageService.SendMessageAsync(newMessage);
            
            // Clear input after sending
            newMessage = "";
            
            // Update UI with most recent messages
            UpdateChatMessagesFromService();
        }
        catch (Exception ex)
        {
            notificationComponent?.ShowErrorMessage($"Failed to send message: {ex.Message}", ex);
            Console.WriteLine($"Error details: {ex}");
        }
        finally
        {
            isSendingMessage = false;
            StateHasChanged();
        }
    }

    private void ShowIdentitiesModal()
    {
        showNsec = false;
        showIdentitiesModal = true;
    }

    private void ShowNsecAndCheckPassword()
    {
        if (!passwordComponent.HasPassword())
        {
            showIdentitiesModal = false;
            passwordComponent.ShowPassword(RetrieveAndShowNsec);
        }
        else
        {
            RetrieveAndShowNsec();
        }
    }

    private async Task RetrieveAndShowNsec()
    {
        try
        {
            var words = await passwordComponent.GetWalletAsync();

            if (currentChat != null)
            {
                if (isFounderChat)
                {
                    // Get founder's nsec
                    var project = founderProjects.FirstOrDefault(p => p.ProjectInfo.ProjectIdentifier == currentChat.ProjectId);
                    if (project != null)
                    {
                        var founderNostrPrivateKey = _derivationOperations.DeriveProjectNostrPrivateKey(words, project.ProjectInfo.FounderKey);
                        var nostrHexSecKey = Encoders.Hex.EncodeData(founderNostrPrivateKey.ToBytes());
                        nsecValue = NostrHelper.ConvertHexToNsec(nostrHexSecKey)!;
                    }
                }
                else
                {
                    // Get investor's nsec
                    var project = investorProjects.FirstOrDefault(p => p.ProjectInfo.ProjectIdentifier == currentChat.ProjectId);
                    if (project != null)
                    {
                        var investorNostrPrivateKey = _derivationOperations.DeriveProjectNostrPrivateKey(words, project.ProjectInfo.FounderKey);
                        var nostrHexSecKey = Encoders.Hex.EncodeData(investorNostrPrivateKey.ToBytes());
                        nsecValue = NostrHelper.ConvertHexToNsec(nostrHexSecKey)!;
                    }
                }
            }

            showNsec = true;
            showIdentitiesModal = true;
            StateHasChanged();
        }
        catch (Exception e)
        {
            notificationComponent.ShowErrorMessage("Failed to retrieve NSEC: " + e.Message);
        }
    }

    private async Task CopyToClipboard(string text)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
        notificationComponent.ShowNotificationMessage("Copied to clipboard", 2);
    }

    private string GetTruncatedNpub(string npub)
    {
        if (string.IsNullOrEmpty(npub)) return "Unknown";
        if (npub.Length <= 12) return npub;
        return $"{npub.Substring(0, 6)}...{npub.Substring(npub.Length - 6)}";
    }

    private string GetTruncatedTxId(string txId)
    {
        if (string.IsNullOrEmpty(txId)) return "Unknown";
        if (txId.Length <= 16) return txId;
        return $"{txId.Substring(0, 8)}...{txId.Substring(txId.Length - 8)}";
    }

    public void Dispose()
    {
        // Remove the message service event handler
        _messageService.OnChange -= HandleMessageServiceChange;
        
        // Dispose of the message service
        _messageService.Dispose();
        
        // Dispose of the refresh timer
        refreshTimer?.Dispose();
    }

    private void BackToProjects()
    {
        showingInvestorsInSidebar = false;
        loadingInvestors = false;
        projectInvestors = new List<InvestmentInfo>();

        // Reset URL to base messages path
        NavigationManager.NavigateTo("/messages", false);
    }

    private async Task InitializeChat()
    {
        try
        {
            // Check if we have required parameters
            if (string.IsNullOrEmpty(ProjectId) || string.IsNullOrEmpty(ChatMode))
            {
                return;
            }

            // Check if password is available, if not show password dialog first
            if (!passwordComponent.HasPassword())
            {
                passwordComponent.ShowPassword(async () =>
                {
                    await InitializeChatWithPassword();
                });
                return;
            }

            await InitializeChatWithPassword();
        }
        catch (Exception ex)
        {
            notificationComponent.ShowErrorMessage("Failed to initialize chat from parameters", ex);
        }
    }

    private async Task InitializeChatWithPassword()
    {
        try
        {
            if (string.IsNullOrEmpty(ChatMode)) return;

            if (ChatMode.ToLower() == "founder")
            {
                // Find the founder project
                var founderProject = founderProjects?.FirstOrDefault(p =>
                    p.ProjectInfo.ProjectIdentifier == ProjectId);

                if (founderProject != null)
                {
                    // If we have a specific partner public key, open chat with that investor
                    if (!string.IsNullOrEmpty(PartnerPubKey))
                    {
                        // First load the investors
                        await SelectFounderChat(founderProject);

                        // Find the matching investor
                        var investor = projectInvestors?.FirstOrDefault(i =>
                            i.InvestorPublicKey == PartnerPubKey ||
                            i.InvestorNPub == PartnerPubKey);

                        if (investor != null)
                        {
                            await StartChatWithInvestor(investor);
                        }
                    }
                    else
                    {
                        // Just show the investors list
                        await SelectFounderChat(founderProject);
                    }
                }
            }
            else if (ChatMode.ToLower() == "investor")
            {
                // Find the investor project
                var investorProject = investorProjects?.FirstOrDefault(p =>
                    p.ProjectInfo.ProjectIdentifier == ProjectId);

                if (investorProject != null)
                {
                    await SelectInvestorChat(investorProject);
                }
            }
        }
        catch (Exception ex)
        {
            notificationComponent?.ShowErrorMessage("Failed to initialize chat with parameters", ex);
        }
    }

    // Helper method to generate URL for chat navigation
    public string GetChatUrl(string projectId, string mode, string partnerPubKey)
    {
        if (string.IsNullOrEmpty(partnerPubKey))
            return $"/messages/{Uri.EscapeDataString(projectId)}/{Uri.EscapeDataString(mode)}";
        else
            return $"/messages/{Uri.EscapeDataString(projectId)}/{Uri.EscapeDataString(mode)}/{Uri.EscapeDataString(partnerPubKey)}";
    }

    // Update browser URL without triggering navigation
    private void UpdateBrowserUrl(string projectId, string mode, string partnerPubKey)
    {
        string url;

        if (string.IsNullOrEmpty(projectId))
        {
            url = "/messages";
        }
        else if (string.IsNullOrEmpty(mode))
        {
            url = $"/messages/{Uri.EscapeDataString(projectId)}";
        }
        else if (string.IsNullOrEmpty(partnerPubKey))
        {
            url = $"/messages/{Uri.EscapeDataString(projectId)}/{Uri.EscapeDataString(mode)}";
        }
        else
        {
            url = $"/messages/{Uri.EscapeDataString(projectId)}/{Uri.EscapeDataString(mode)}/{Uri.EscapeDataString(partnerPubKey)}";
        }

        // Replace current URL without adding to browser history
        NavigationManager.NavigateTo(url, false, true);
    }
}

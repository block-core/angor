<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:dt="clr-namespace:AngorApp.Sections.Browse.Details"
             xmlns:controls="clr-namespace:AngorApp.UI.Controls"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             mc:Ignorable="d" d:DesignWidth="360"
             x:Class="AngorApp.Sections.Browse.Details.Stages" x:DataType="dt:IProjectDetailsViewModel">

    <Design.DataContext>
        <dt:ProjectDetailsViewModelDesign />
    </Design.DataContext>

    <Card Header="Project Stages" Subheader="Funding stages and release schedule">
        <DockPanel VerticalSpacing="20">
            <!-- Stage Overview -->
            <Card DockPanel.Dock="Top">
                <BalancedWrapGrid MinItemWidth="120" VerticalSpacing="30">
                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                        <i:Icon FontSize="24" Value="fa-solid fa-play-circle" Foreground="{DynamicResource SystemAccentColor}" />
                        <TextBlock Text="Current Stage" Classes="Wrap" FontSize="12" Opacity="0.7" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding CurrentStage.Index, TargetNullValue=Unknown, FallbackValue=Unknown}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                        <i:Icon FontSize="24" Value="fa-solid fa-list-ol" Foreground="Orange" />
                        <TextBlock Text="Total Stages" Classes="Wrap" FontSize="12" Opacity="0.7" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding Project.Stages, Converter={x:Static Enumerable.Count}}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                        <i:Icon FontSize="24" Value="fa-solid fa-calendar-alt" Foreground="LimeGreen" />
                        <TextBlock Classes="Wrap" Text="Next Release" FontSize="12" Opacity="0.7" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding NextRelease, Converter={x:Static controls:AngorConverters.HumanizeTimeSpan}, StringFormat='In {0}', FallbackValue='Unknown'}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" />
                    </StackPanel>
                </BalancedWrapGrid>
            </Card>

            <!-- Data Grid with Enhanced Styling -->
            <Card Header="Stage Details" Theme="{StaticResource WideCard}">
                <ResponsivePresenter Breakpoint="600">
                    <ResponsivePresenter.Narrow>
                        <ItemsControl ItemsSource="{Binding Project.Stages}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Classes="SmallGap" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Classes="Card" Padding="10" Container.Name="Root" Container.Sizing="Width">
                                        <Border.Styles>
                                            <Style Selector="EdgePanel /template/ ContentControl#StartContent">
                                                <Setter Property="FontWeight" Value="Bold" />
                                            </Style>
                                            <ContainerQuery Name="Root" Query="min-width:0 and max-width:299">
                                                <Style Selector="EdgePanel">
                                                    <Setter Property="Theme" Value="{StaticResource StackingEdgePanel}" />
                                                </Style>
                                            </ContainerQuery>    
                                            <ContainerQuery Query="min-width:300">
                                                <Style Selector="EdgePanel">
                                                    <Setter Property="Theme" Value="{StaticResource PropertyEdgePanel}" />
                                                </Style>
                                            </ContainerQuery>
                                        </Border.Styles>
                                        <HeaderedContainer TextBlock.TextWrapping="Wrap" Padding="0" Margin="10" Header="{ItemIndex StartFromOne=True, StringFormat='Stage {0}'}">
                                            <StackPanel Grid.IsSharedSizeScope="True" Classes="SmallGap">
                                                <EdgePanel StartContent="Percentage" EndContent="{Binding RatioOfTotal, StringFormat='{}{0:P0}'}" />
                                                <EdgePanel StartContent="Release date" EndContent="{Binding ReleaseDate, StringFormat=d}" />
                                                <EdgePanel StartContent="Time until release" EndContent="{Binding ReleaseDate, Converter={x:Static controls:AngorConverters.TimeLeftDateTime}}" />
                                                <EdgePanel StartContent="Amount" EndContent="{Binding AmountUI.ShortDecimalString}" />
                                            </StackPanel>
                                        </HeaderedContainer>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ResponsivePresenter.Narrow>
                    <ResponsivePresenter.Wide>
                        <SlimDataGrid ItemsSource="{Binding Project.Stages}"
                                      Background="Transparent"
                                      Margin="0,10,0,0">
                            <SlimDataGrid.Columns>
                                <Column Header="STAGE" Binding="{Binding Index, Converter={x:Static MiscConverters.AddOne}}" Width="80" />
                                <Column Header="STAGE %" Binding="{Binding RatioOfTotal, StringFormat={}{0:P0}}" Width="100" />
                                <Column Header="RELEASE DATE" Binding="{Binding ReleaseDate, StringFormat=d}" Width="150" />
                                <Column Header="DAYS UNTIL STAGE" Binding="{Binding ReleaseDate, Converter={x:Static controls:AngorConverters.TimeLeftDateTime}}" Width="Auto" />
                                <Column Header="AMOUNT PER STAGE"
                                        Binding="{Binding AmountUI.ShortDecimalString}" Width="200">
                                </Column>
                            </SlimDataGrid.Columns>
                        </SlimDataGrid>
                    </ResponsivePresenter.Wide>
                </ResponsivePresenter>
            </Card>
        </DockPanel>
    </Card>

</UserControl>
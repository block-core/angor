<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:dt="clr-namespace:AngorApp.Sections.Browse.Details"
             xmlns:controls="clr-namespace:AngorApp.UI.Controls"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="800"
             x:Class="AngorApp.Sections.Browse.Details.Stages" x:DataType="dt:IProjectDetailsViewModel">

    <Design.DataContext>
        <dt:ProjectDetailsViewModelDesign />
    </Design.DataContext>

    <Card Header="Project Stages" Subheader="Funding stages and release schedule">
        <Card.HeaderStartContent>
            <i:Icon FontSize="40" Value="fa-solid fa-timeline" />
        </Card.HeaderStartContent>

        <DockPanel VerticalSpacing="20">
            <!-- Stage Overview -->
            <Card DockPanel.Dock="Top">
                <BalancedWrapGrid MinItemWidth="120" VerticalSpacing="30">
                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                        <i:Icon FontSize="24" Value="fa-solid fa-play-circle" Foreground="{DynamicResource SystemAccentColor}" />
                        <TextBlock Text="Current Stage" Classes="Wrap" FontSize="12" Opacity="0.7" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding CurrentStage.Index, TargetNullValue=Unknown, FallbackValue=Unknown}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                        <i:Icon FontSize="24" Value="fa-solid fa-list-ol" Foreground="Orange" />
                        <TextBlock Text="Total Stages" Classes="Wrap" FontSize="12" Opacity="0.7" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding Project.Stages, Converter={x:Static Enumerable.Count}}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                        <i:Icon FontSize="24" Value="fa-solid fa-calendar-alt" Foreground="LimeGreen" />
                        <TextBlock Classes="Wrap" Text="Next Release" FontSize="12" Opacity="0.7" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding NextRelease, Converter={x:Static controls:AngorConverters.HumanizeTimeSpan}, StringFormat='In {0}', FallbackValue='Unknown'}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" />
                    </StackPanel>
                </BalancedWrapGrid>
            </Card>

            <!-- Data Grid with Enhanced Styling -->
            <Card Header="Stage Details" Theme="{StaticResource WideCard}">
                <Panel Container.Name="RootPanel" Container.Sizing="Width">
                    <Panel.Styles>
                        <ContainerQuery Name="RootPanel" Query="min-width:0">
                            <Style Selector="SlimDataGrid">
                                <Setter Property="IsVisible" Value="False" />
                            </Style>
                            <Style Selector="ItemsControl#PlainList">
                                <Setter Property="IsVisible" Value="True" />
                            </Style>
                        </ContainerQuery>
                        <ContainerQuery Name="RootPanel" Query="min-width:600">
                            <Style Selector="SlimDataGrid">
                                <Setter Property="IsVisible" Value="True" />
                            </Style>
                            <Style Selector="ItemsControl#PlainList">
                                <Setter Property="IsVisible" Value="False" />
                            </Style>
                        </ContainerQuery>
                    </Panel.Styles>
                    <SlimDataGrid ItemsSource="{Binding Project.Stages}"
                                  Background="Transparent"
                                  Margin="0,10,0,0">
                        <SlimDataGrid.Columns>
                            <Column Header="STAGE" Binding="{Binding Index}" Width="80" />
                            <Column Header="STAGE %" Binding="{Binding RatioOfTotal, StringFormat={}{0:P0}}" Width="100" />
                            <Column Header="RELEASE DATE" Binding="{Binding ReleaseDate, StringFormat=d}" Width="150" />
                            <Column Header="DAYS UNTIL STAGE" Binding="{Binding ReleaseDate, Converter={x:Static controls:AngorConverters.TimeLeftDateTime}}" Width="Auto" />
                            <Column Header="AMOUNT PER STAGE"
                                    Binding="{Binding Amount, Converter={x:Static controls:AngorConverters.SatsToBtc}, StringFormat={}{0} TBTC}" Width="200">
                            </Column>
                        </SlimDataGrid.Columns>
                    </SlimDataGrid>
                    <ItemsControl x:Name="PlainList" ItemsSource="{Binding Project.Stages}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Classes="SmallGap" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Classes="Card" Padding="10">
                                    <HeaderedContainer Header="{ItemIndex StartFromOne=True, StringFormat='Stage {0}'}">
                                        <StackPanel Grid.IsSharedSizeScope="True" Classes="SmallGap">
                                            <EdgePanel Theme="{StaticResource PropertyEdgePanel}" StartContent="Percentage" EndContent="{Binding RatioOfTotal, StringFormat='{}{0:P0}'}" />
                                            <EdgePanel Theme="{StaticResource PropertyEdgePanel}" StartContent="Release date" EndContent="{Binding ReleaseDate, StringFormat=d}" />
                                            <EdgePanel Theme="{StaticResource PropertyEdgePanel}" StartContent="Time until release" EndContent="{Binding ReleaseDate, Converter={x:Static controls:AngorConverters.TimeLeftDateTime}}" />
                                            <EdgePanel Theme="{StaticResource PropertyEdgePanel}" StartContent="Amount" EndContent="{Binding AmountUI.DecimalString}" />
                                        </StackPanel>
                                    </HeaderedContainer>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                </Panel>
            </Card>
        </DockPanel>
    </Card>

</UserControl>
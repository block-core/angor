<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:co="clr-namespace:AngorApp.UI.Shared.Controls"
             xmlns:manage="clr-namespace:AngorApp.UI.Sections.Portfolio.Manage"
             xmlns:ui="clr-namespace:Zafiro.UI;assembly=Zafiro.UI"
             mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="800"
             x:Class="AngorApp.UI.Sections.Portfolio.Manage.ManageInvestorProjectView" x:DataType="manage:IManageInvestorProjectViewModel">

    <Design.DataContext>
        <manage:ManageInvestorProjectViewModelSample />
    </Design.DataContext>
    
    <Interaction.Behaviors>
        <LoadedTrigger>
            <InvokeCommandAction Command="{Binding Load}" />
        </LoadedTrigger>
    </Interaction.Behaviors>

    <co:PageContainer>
        <DockPanel VerticalSpacing="20">
            <Card DockPanel.Dock="Top" Theme="{StaticResource WideCard}" Header="Manage Investment" Subheader="{Binding State^.Project.Name}">
                <Card.HeaderStartContent>
                    <ui:Icon Source="fa-list-check" />
                </Card.HeaderStartContent>
                <Card.HeaderEndContent>
                    <StackPanel Orientation="Horizontal" Classes="SmallGap" HorizontalAlignment="Stretch">
                        <EnhancedButton Icon="{Icon fa-arrows-rotate}" Command="{Binding Load}" />
                        <EnhancedButton Content="Message" />
                    </StackPanel>
                </Card.HeaderEndContent>
            </Card>
            <Loading IsLoading="{Binding Load.IsExecuting^}" LoadingText="Loading investment details...">
                <ScrollViewer>
                    <StackPanel Classes="BigGap">
                        <BalancedWrapGrid MinItemWidth="200" HorizontalSpacing="20" VerticalSpacing="20">
                            <Card Header="Total Funds" Theme="{StaticResource LeftItemCard}" Subheader="{Binding State^.Project.TotalFunds.DecimalString}" />
                            <Card Header="Expiry Date" Theme="{StaticResource LeftItemCard}" Subheader="{Binding State^.Project.ExpiryDate, Converter={x:Static co:AngorConverters.HumanizeDateTime}}" />
                            <Card Header="Penalty Period" Theme="{StaticResource LeftItemCard}" Subheader="{Binding State^.Project.PenaltyPeriod.TotalDays, StringFormat='{}{0} Days'}" />
                            <Card Header="Transaction" Theme="{StaticResource LeftItemCard}">
                                <Card.Subheader>
                                    <EnhancedButton Command="{Binding State^.ViewTransaction}" FontSize="{StaticResource FontSizeSmall}" Content="View" />
                                </Card.Subheader>
                            </Card>
                        </BalancedWrapGrid>
                        
                        <!-- Information banner for below threshold investments -->
                        <Card IsVisible="{Binding State^.IsBelowPenaltyThreshold}" Theme="{StaticResource WideCard}">
                            <StackPanel Spacing="10">
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <TextBlock FontSize="18">??</TextBlock>
                                    <TextBlock Text="Investment Below Penalty Threshold" FontWeight="SemiBold" />
                                </StackPanel>
                                <TextBlock TextWrapping="Wrap" 
                                          Text="Your investment amount is below the penalty threshold, allowing you to claim funds immediately without waiting for the project to expire." />
                            </StackPanel>
                        </Card>
                        
                        <!-- Information banner for end of project -->
                        <Card IsVisible="{Binding State^.EndOfProject}" Theme="{StaticResource WideCard}">
                            <StackPanel Spacing="10">
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <TextBlock FontSize="18">?</TextBlock>
                                    <TextBlock Text="Project Has Expired" FontWeight="SemiBold" />
                                </StackPanel>
                                <TextBlock TextWrapping="Wrap" 
                                          Text="The project has reached its expiry date. You can now claim any remaining unspent funds." />
                            </StackPanel>
                        </Card>
                        
                        <HeaderedContainer Header="Actions">
                            <EnhancedButton IsVisible="{Binding $self.IsEffectivelyEnabled}" Content="{Binding State^.BatchAction.Text, FallbackValue='Empty'}" Command="{Binding State^.BatchAction}" />
                        </HeaderedContainer>
                        
                        <HeaderedContainer Header="Investment Keys">
                            <StackPanel Spacing="10">
                                <TextBlock Text="Your investor private key (nsec) for this project. Keep this secure and never share it." 
                                           TextWrapping="Wrap" 
                                           Opacity="0.7" />
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <EnhancedButton Content="Reveal nsec" 
                                                    Command="{Binding State^.GetNsec}" 
                                                    Icon="{Icon fa-key}" />
                                </StackPanel>
                            </StackPanel>
                        </HeaderedContainer>
                        
                        <ResponsivePresenter Breakpoint="600">
                            <ResponsivePresenter.Narrow>
                                <ItemsControl Classes="ShowEmptyContent" Empty.Content="No release items found" ItemsSource="{Binding State^.Stages}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Classes="BigGap" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Card Theme="{StaticResource WideCard}" Header="{ItemIndex StartFromOne=True, StringFormat='Investment {0}'}">
                                                <StackPanel Grid.IsSharedSizeScope="True" Classes="SmallGap">
                                                    <EdgePanel Theme="{StaticResource PropertyEdgePanel}" StartContent="Stage:" Content="{Binding  Stage}" />
                                                    <EdgePanel Theme="{StaticResource PropertyEdgePanel}" StartContent="Amount:" Content="{Binding Amount.DecimalString}" />
                                                    <EdgePanel Theme="{StaticResource PropertyEdgePanel}" StartContent="Status:" Content="{Binding Status}" />
                                                </StackPanel>
                                            </Card>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ResponsivePresenter.Narrow>
                            <ResponsivePresenter.Wide>
                                <SlimDataGrid ItemsSource="{Binding State^.Stages}">
                                    <SlimDataGrid.Columns>
                                        <Column Header="Stage" Binding="{Binding Stage}" />
                                        <Column Header="Amount" Binding="{Binding Amount.DecimalString}" />
                                        <Column Header="Status" Binding="{Binding Status}" />
                                    </SlimDataGrid.Columns>
                                </SlimDataGrid>
                            </ResponsivePresenter.Wide>
                        </ResponsivePresenter>
                    </StackPanel>
                </ScrollViewer></Loading>
        </DockPanel>
    </co:PageContainer>
</UserControl>
